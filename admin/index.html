<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSA Admin</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
</head>
<body>

  <!-- LOGIN (email + password) -->
  <div id="login">
    <div class="psa-login">
      <h1>PSA Admin</h1>
      <div id="auth-note" class="muted">not signed in</div>

      <div class="login-col" style="display:flex;flex-direction:column;gap:8px;min-width:300px;">
        <input id="loginEmail" type="email" placeholder="Email" autocomplete="username" />
        <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />

        <div class="login-row" style="display:flex;gap:8px;">
<button id="btnEmailLogin" class="btn primary" type="button">Sign in</button>
          <button
            id="btnReset"
            class="btn"
            type="button"
            onclick="window.__psaSendReset && window.__psaSendReset()"
          >
            Forgot password
          </button>
        </div>

        <div id="err" class="error"></div>
        <div id="ok"  class="muted"></div>
      </div>
    </div>
  </div>

  <!-- APP SHELL -->
  <div id="shell" class="hide">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a id="nav-active" class="sidebar-item active" href="/admin/index.html">Active submissions</a>
        <a id="nav-groups" class="sidebar-item" href="/admin/groups.html">Groups</a>
        <a id="nav-billing" class="sidebar-item" href="/admin/billing.html">Billing</a>
        <a id="nav-reports" class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a id="nav-settings" class="sidebar-item" href="/admin/settings.html">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <strong>Active submissions</strong>
          </div>
          <div class="top-actions">
            <span id="auth-note-top" class="muted">signed in</span>
          </div>
        </div>

        <div class="views-bar" id="views-bar"></div>

        <!-- ===================== Submissions view ===================== -->
        <section id="view-submissions">
          <div class="toolbar">
            <input id="q" type="search" placeholder="Search email or submission…" />
            <button id="btnDate" class="btn" type="button" title="Filter by date">Dates: All</button>
            <div id="date-popover" class="popover hide" role="dialog" aria-modal="true">
              <div id="rangeCal" class="range-cal">
                <div class="rc-side">
                  <button id="datePresetToday" class="btn" type="button">Today</button>
                  <button id="datePreset7" class="btn" type="button">Last 7 days</button>
                  <button id="datePreset30" class="btn" type="button">Last 30 days</button>
                </div>
                <div class="rc-months">
                  <div class="rc-month">
                    <div class="rc-head">
                      <button id="rc-prev" class="btn" type="button" title="Previous month">‹</button>
                      <div id="rc-title-left" class="rc-title"></div>
                    </div>
                    <div id="rc-grid-left" class="rc-grid"></div>
                  </div>
                  <div class="rc-month">
                    <div class="rc-head">
                      <div id="rc-title-right" class="rc-title"></div>
                      <button id="rc-next" class="btn" type="button" title="Next month">›</button>
                    </div>
                    <div id="rc-grid-right" class="rc-grid"></div>
                  </div>
                </div>
              </div>
              <div class="rc-foot">
                <span id="rc-range-label" class="muted"></span>
                <div class="spacer"></div>
                <button id="dateClear"  class="btn" type="button">Clear</button>
                <button id="dateCancel" class="btn" type="button">Cancel</button>
                <button id="dateApply"  class="btn primary" type="button">Apply</button>
              </div>
              <input id="dateFrom" type="date" hidden />
              <input id="dateTo"   type="date" hidden />
            </div>

            <div class="filters">
              <button id="btnStatus" class="btn" type="button">Status: All</button>
              <div id="status-popover" class="popover hide" role="dialog" aria-modal="true">
                <div class="status-list">
                  <label><input type="checkbox" data-status="submitted"> submitted</label>
                  <label><input type="checkbox" data-status="submitted_paid"> submitted_paid</label>
                  <label><input type="checkbox" data-status="pending_payment"> pending_payment</label>
                  <label><input type="checkbox" data-status="paid"> paid</label>
                  <label><input type="checkbox" data-status="fulfilled"> fulfilled</label>
                </div>
                <div class="rc-foot">
                  <span class="spacer"></span>
                  <button id="statusClear" class="btn" type="button">Clear</button>
                  <button id="statusApply" class="btn primary" type="button">Apply</button>
                </div>
              </div>

              <select id="fEval" aria-label="Evaluation">
                <option value="all">Evaluation: All</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>

            <select id="fService" title="Grading service" style="min-width:220px">
              <option value="">Grading: All</option>
            </select>

            <span class="count-pill"><span id="countPill">0</span></span>
            <div class="spacer"></div>
            <button id="btnResetFilters" class="btn" type="button" title="Reset all filters">Reset</button>
            <button id="btnRefresh" class="btn" type="button">Refresh</button>
          </div>

          <div id="subsErr" class="error hide"></div>

          <div class="table-wrap">
            <div class="table-scroller">
              <table class="table" id="subsTable">
                <thead id="subsHead"></thead>
                <tbody id="subsTbody"></tbody>
              </table>
            </div>
            <div id="subsEmpty" class="empty hide">No submissions found.</div>
          </div>

          <div class="pagination">
            <span class="page-range" id="page-range">0–0 of 0</span>
            <button class="page-btn" id="prev-page">‹</button>
            <button class="page-btn" id="next-page">›</button>
          </div>
        </section>

        <section id="view-groups" class="hide"></section>
      </main>
    </div>
  </div>

  <!-- Columns Panel -->
  <div class="columns-panel-backdrop" id="columns-backdrop" aria-hidden="true">
    <div class="columns-panel">
      <div class="columns-head">
        <div style="font-weight:700">Columns</div>
        <button id="close-columns" class="btn">Close</button>
      </div>
      <div class="columns-body">
        <div id="columns-list"></div>
      </div>
      <div class="columns-foot">
        <button id="columns-cancel" class="btn">Cancel</button>
        <button id="columns-save" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Module entrypoint -->
  <script type="module" src="/admin/js/admin.app.js"></script>

  <!-- Small helpers for login/reset -->
  <script>
    // Email/password sign in -> calls /api/admin/login
    window.__psaEmailLogin = async function () {
      const email = (document.getElementById('loginEmail')?.value || '').trim();
      const password = document.getElementById('loginPassword')?.value || '';
      const err = document.getElementById('err');
      err.textContent = '';

      if (!email)   { err.textContent = 'Enter your email.'; return; }
      if (!password){ err.textContent = 'Enter your password.'; return; }

      const btn = document.getElementById('btnEmailLogin'); // <-- fixed id
      btn.disabled = true; const old = btn.textContent; btn.textContent = 'Signing in…';
      try {
        const r = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ email, password })
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j.error || 'Sign-in failed');

        // Server sets auth cookie; reload so admin.app.js enters the app
        location.reload();
      } catch (e) {
        err.textContent = e.message || String(e);
      } finally {
        btn.disabled = false; btn.textContent = old;
      }
    };

    // Sends a password reset email using the email field
    window.__psaSendReset = async function () {
      const email = (document.getElementById('loginEmail')?.value || '').trim();
      const err = document.getElementById('err');
      const ok  = document.getElementById('ok');
      err.textContent = ''; ok.textContent = '';

      if (!email) { err.textContent = 'Enter your email first.'; return; }

      try {
        const r = await fetch('/api/admin/users/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ email })
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j.error || 'Could not send reset email');

        ok.textContent = 'Reset email sent (check inbox/spam).';
      } catch (e) {
        err.textContent = e.message || String(e);
      }
    };

    // Also bind via JS to be extra safe
    (function(){
      const b1 = document.getElementById('btnEmailLogin');
      const b2 = document.getElementById('btnReset');
      b1 && b1.addEventListener('click', window.__psaEmailLogin);
      b2 && b2.addEventListener('click', window.__psaSendReset);
      window.__psaLogin = undefined; // prevent old passcode handler from being used anywhere
    })();
  </script>
</body>
</html>
