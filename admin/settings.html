<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PSA Admin – Settings</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
  <meta name="robots" content="noindex">
</head>
<body>
  <div id="shell">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a id="nav-active"  class="sidebar-item" href="/admin/index.html">Active submissions</a>
        <a id="nav-groups"  class="sidebar-item" href="/admin/groups.html">Groups</a>
        <a id="nav-billing" class="sidebar-item" href="/admin/billing.html">Billing</a>
        <a id="nav-reports" class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a id="nav-settings" class="sidebar-item active" href="/admin/settings.html">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <!-- Access-restricted view (non-owners) -->
        <div id="settings-denied" style="display:none;padding:24px;">
          <h2 style="margin:0 0 8px;">Access restricted</h2>
          <p class="muted" style="margin:0 0 16px;">You need the owner role to view Settings.</p>
          <a class="btn" href="/admin/">Back to dashboard</a>
        </div>

        <!-- Owner-only content -->
        <div id="settings-owner">
          <div class="topbar">
            <div class="brand">
              <span class="dot"></span>
              <strong>Settings</strong>
              <span class="muted" style="margin-left:6px;">/ Users</span>
            </div>
          </div>

          <div style="padding:16px; display:grid; grid-template-columns: 1fr; gap:16px;">
            <!-- Invite form -->
            <div style="border:1px solid #eee;border-radius:12px;padding:12px;">
              <div style="font-weight:600;margin-bottom:8px;">Invite user</div>
              <form id="inviteForm" style="display:flex;flex-wrap:wrap;gap:8px;align-items:end;">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label class="muted" style="font-size:12px;">Name</label>
                  <input id="invName" type="text" placeholder="Jane Doe" style="min-width:220px;">
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label class="muted" style="font-size:12px;">Email</label>
                  <input id="invEmail" type="email" placeholder="jane@example.com" required style="min-width:260px;">
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <label class="muted" style="font-size:12px;">Role</label>
                  <select id="invRole" style="min-width:160px;">
                    <option value="staff">Staff</option>
                    <option value="manager">Manager</option>
                    <option value="owner">Owner</option>
                  </select>
                </div>
                <button id="btnInvite" type="submit" class="btn primary" style="min-width:120px;">Invite</button>
                <div id="inviteMsg" class="muted" style="font-size:12px;"></div>
              </form>
            </div>

            <!-- Users table -->
            <div style="border:1px solid #eee;border-radius:12px;padding:12px;">
              <div style="font-weight:600;margin-bottom:8px;">Users</div>
              <div class="users-wrap" style="overflow:auto;">
                <table style="width:100%;min-width:840px;border-collapse:separate;border-spacing:0;">
                  <thead>
                    <tr>
                      <th style="text-align:left;">Name</th>
                      <th style="text-align:left;">Email</th>
                      <th style="text-align:left;">Role</th>
                      <th style="text-align:left;">Status</th>
                      <th style="text-align:left;">Added</th>
                      <th style="text-align:left;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="usersTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div> <!-- /#settings-owner -->
      </main>
    </div>
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    const state = { meEmail: null };

    function esc(s){return String(s==null?"":s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    function timefmt(iso){
      if(!iso) return '—';
      const d = new Date(iso);
      return d.toLocaleString();
    }

    async function fetchMe(){
      try {
        const r = await fetch('/api/admin/users/me', { credentials:'same-origin' });
        if (r.ok) {
          const j = await r.json().catch(()=>({}));
          state.meEmail = (j && j.email) ? String(j.email).toLowerCase() : null;
        }
      } catch {}
    }

async function fetchUsers(){
  const tbody = $("usersTbody");
  if (!tbody) return; // non-owners won't have this section

  const r = await fetch('/api/admin/users/list', { credentials: 'same-origin' });
  const j = await r.json().catch(()=>({users:[]}));
  const rows = j.users || [];

  tbody.innerHTML = rows.map(u => {
    const id = u.id || u.auth_user_id || u.user_id || '';
    const email = String(u.email || '').trim();
    const isSelf = state.meEmail && email.toLowerCase() === state.meEmail;

    return `
      <tr>
        <td>${esc(u.name||'—')}</td>
        <td>${esc(email)}</td>
        <td>
  <select data-role
          data-id="${esc(id)}"
          ${isSelf ? 'disabled title="You can’t change your own role"' : ''}>
    ${['staff','manager','owner'].map(r => `
      <option value="${r}" ${String(u.role||'staff').toLowerCase()===r?'selected':''}>${r}</option>
    `).join('')}
  </select>
</td>
        <td>${u.is_active ? 'Active' : 'Disabled'}</td>
        <td>${timefmt(u.created_at)}</td>
        <td style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" data-act="reset" data-email="${esc(email)}">Send reset</button>
          <button class="btn danger"
                  data-act="delete"
                  data-id="${esc(id)}"
                  data-email="${esc(email)}"
                  ${isSelf ? 'disabled title="You can’t delete yourself"' : ''}>
            Delete
          </button>
        </td>
      </tr>
    `;
  }).join('');
}

    async function inviteUser(e){
      e.preventDefault();
      const btn = $("btnInvite");
      const msg = $("inviteMsg");
      msg.textContent = '';
      btn.disabled = true; btn.textContent = 'Inviting…';
      try {
        const payload = {
          name: $("invName").value.trim(),
          email: $("invEmail").value.trim(),
          role: $("invRole").value
        };
        const r = await fetch('/api/admin/users/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        const j = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(j?.error || 'Invite failed');
        msg.textContent = `Invite sent to ${payload.email}.`;
        $("invName").value = ''; $("invEmail").value = ''; $("invRole").value='staff';
        await fetchUsers();
      } catch (err) {
        console.error(err);
        msg.textContent = String(err?.message || err);
      } finally {
        btn.disabled = false; btn.textContent = 'Invite';
      }
    }

    // Bind invite submit
    $("inviteForm")?.addEventListener("submit", inviteUser);

    // Actions (event delegation bound to tbody)
// Actions: reset & delete (event delegation)
$("usersTbody")?.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-act]');
  if (!btn) return;

  const act = btn.dataset.act;

  // SEND PASSWORD RESET
  if (act === 'reset') {
    const email = btn.dataset.email;
    const prevText = btn.textContent;
    btn.disabled = true; btn.textContent = 'Sending…';
    try {
      const r = await fetch('/api/admin/users/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ email })
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || 'Failed to send reset');
      alert(`Reset email sent to ${email}.`);
    } catch (err) {
      console.error(err);
      alert('Could not send reset: ' + (err.message || err));
    } finally {
      btn.disabled = false; btn.textContent = prevText;
    }
    return;
  }

  // DELETE USER
  if (act === 'delete') {
    const id = btn.dataset.id;
    const email = btn.dataset.email;

    // guard: can't delete yourself
    if (state.meEmail && email.toLowerCase() === state.meEmail) {
      alert("You can't delete yourself.");
      return;
    }

    if (!id) { alert('Missing user id.'); return; }
    if (!confirm(`Remove ${email}? They will lose access.`)) return;

    const prevText = btn.textContent;
    btn.disabled = true; btn.textContent = 'Removing…';
    try {
      const r = await fetch('/api/admin/users/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ id })
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || 'Delete failed');

      await fetchUsers();
    } catch (err) {
      console.error(err);
      alert('Could not delete: ' + (err.message || err));
    } finally {
      btn.disabled = false; btn.textContent = prevText;
    }
    return;
  }
});

// Role change (event delegation) — separate listener
$("usersTbody")?.addEventListener('change', async (e) => {
  const sel = e.target.closest('select[data-role]');
  if (!sel) return;

  const id = sel.getAttribute('data-id');
  const newRole = sel.value;
  const prev = sel.getAttribute('data-prev') || sel.value; // first time prev may not exist

  // remember previous value
  sel.setAttribute('data-prev', prev);

  if (!confirm(`Change role to "${newRole}"?`)) {
    sel.value = prev;
    return;
  }

  sel.disabled = true;
  try {
    const r = await fetch('/api/admin/users/update-role', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ id, role: newRole })
    });
    const j = await r.json().catch(()=>({}));
    if (!r.ok) throw new Error(j.error || 'Update failed');

    // success: new prev = current value
    sel.setAttribute('data-prev', newRole);
  } catch (err) {
    alert(err.message || String(err));
    // revert UI on error
    sel.value = prev;
  } finally {
    sel.disabled = false;
  }
});


    // Sign out
    document.getElementById('sidebar-signout')?.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await fetch('/api/admin-logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
      window.location.replace('/admin');
    });

// ── simple cookie reader ──
function getCookie(n){
  const m = document.cookie.split('; ').find(v => v.startsWith(n + '='));
  return m ? decodeURIComponent(m.split('=')[1]) : '';
}
const role = (getCookie('psa_role') || '').toLowerCase();
const isOwner = role === 'owner';

// Init: only owners load the users list/UI
(async function init(){
  if (!isOwner) {
    // hard switch UI immediately to prevent any API calls
    const owner  = document.getElementById('settings-owner');
    const denied = document.getElementById('settings-denied');
    if (owner)  owner.style.display = 'none';
    if (denied) denied.style.display = 'block';
    return;
  }
  await fetchMe();
  await fetchUsers();
})();
  </script>
</body>
</html>
