<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSA Admin – Invoice Builder</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
</head>
<body>
  <div id="shell">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a class="sidebar-item" href="/admin/index.html">Active submissions</a>
        <a class="sidebar-item" href="/admin/groups.html">Groups</a>
        <a class="sidebar-item" href="/admin/billing.html">Billing</a>
        <a class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a class="sidebar-item" href="#" title="Coming soon">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <!-- Top bar -->
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <strong>Invoice Builder</strong>
          </div>
          <div class="top-actions" style="display:flex;gap:8px;align-items:center;">
            <a class="btn" href="/admin/billing.html">← Back to Billing</a>
            <button id="btnSaveDraft" class="btn" type="button" disabled>Save</button>
            <button id="btnSend" class="btn primary" type="button" title="Coming soon" disabled>Send</button>
          </div>
        </div>

        <!-- Preview-as-page (same DOM as the overlay uses) -->
        <div id="previewPage">
          <!-- header -->
          <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #eee;">
            <div style="flex:1 1 auto;">
              <div style="font-weight:700;">Draft Invoice Preview</div>
              <div class="muted" style="font-size:12px;">
                <span class="js-cust-email"></span> ·
                <span class="js-sub-count">0</span> submissions ·
                <span class="js-card-count">0</span> cards
              </div>
            </div>
            <button type="button" id="btnDraftSave" class="btn" style="min-width:120px;" disabled>Save</button>
          </div>

          <!-- body -->
          <div id="draftBody" style="padding:12px 16px; display:flex; flex-direction:column; gap:12px; overflow:hidden; flex:1 1 auto; min-height:0;">
            <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start;">
              <!-- left: compact info boxes -->
              <div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                  <!-- Submissions box -->
                  <div style="border:1px solid #eee;border-radius:12px;padding:10px;">
                    <div style="font-weight:600;margin-bottom:6px;">Submissions</div>
                    <div class="js-sub-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                  </div>

                  <!-- Groups box -->
                  <div style="border:1px solid #eee;border-radius:12px;padding:10px;">
                    <div style="font-weight:600;margin-bottom:6px;">Groups</div>
                    <div class="js-group-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                  </div>
                </div>

                <!-- Received range (small, under the boxes) -->
                <div class="js-range muted" style="margin-top:8px;font-size:12px;"></div>
              </div>

              <!-- right: summary -->
              <div>
                <div style="border:1px solid #eee;border-radius:12px;padding:12px;">
                  <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                    <div>Subtotal (est.)</div>
                    <div class="js-subtotal">$—</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                    <div>Shipping (flat)</div>
                    <div class="js-ship">$5.00</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #eee;font-weight:700;">
                    <div>Total (est.)</div>
                    <div class="js-total">$—</div>
                  </div>
                  <div class="muted" style="font-size:12px;margin-top:8px;">Tax will be calculated by Shopify on save.</div>
                </div>
              </div> <!-- end right summary column -->
            </div>

            <!-- Cards -->
            <div style="margin-top:12px; display:flex; flex-direction:column; flex:1 1 auto; min-height:0;">
              <div style="font-weight:600;margin-bottom:6px;">Cards</div>
              <div class="cards-wrap" style="border:1px solid #eee;border-radius:12px; flex:1 1 auto; min-height:0; overflow:auto; overscroll-behavior:contain;">
                <table class="cards-table" style="width:100%;min-width:960px;border-collapse:separate;border-spacing:0;table-layout:fixed;">
                  <colgroup>
                    <col style="width:140px;">  <!-- Submission -->
                    <col style="width:120px;">  <!-- Date of break -->
                    <col style="width:160px;">  <!-- Break channel -->
                    <col style="width:110px;">  <!-- Break # -->
                    <col style="width:auto;">   <!-- Card description -->
                    <col style="width:120px;">  <!-- Grading ($) -->
                    <col style="width:140px;">  <!-- Upcharge ($) -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Submission</th>
                      <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Date of break</th>
                      <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Break channel</th>
                      <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Break #</th>
                      <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Card description</th>
                      <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Grading ($)</th>
                      <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Upcharge ($)</th>
                    </tr>
                  </thead>
                  <tbody id="cardsTbody"></tbody>
                </table>
              </div>
              <div id="cardsEmpty" class="empty hide" style="padding:12px;">No cards to show.</div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    // ===== Utilities =====
    const $ = (id) => document.getElementById(id);
    function money(n){ const x = Number(n); return Number.isFinite(x) ? x.toLocaleString(undefined, { style:'currency', currency:'USD' }) : '$—'; }
    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function fmtDateISOish(v){
      if (!v) return '—';
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) { const s = String(v); return s.length >= 10 ? s.slice(0,10) : s; }
      return d.toISOString().slice(0,10);
    }
    function pill(text){ const span=document.createElement('span'); span.textContent=text; span.className='pill'; span.style.padding='4px 8px'; return span; }
    function setList(el,arr){ if(!el) return; el.innerHTML=''; (arr||[]).forEach(v=>el.appendChild(pill(v))); }

    // ===== Sign out =====
    $('sidebar-signout')?.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await fetch('/api/admin-logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
      window.location.replace('/admin');
    });

    // ===== Settings & constants (identical to overlay) =====
    const DEFAULT_SETTINGS = { grade_fee: 20.00, shipping: 5.00 };
    let SETTINGS = { ...DEFAULT_SETTINGS };
    const SAVE_UPCHARGES_ENDPOINT = '/api/admin/billing/preview/save';

    async function loadSettings(){
      try {
        const r = await fetch('/api/admin/settings', { credentials: 'same-origin' });
        if (r.ok) {
          const j = await r.json().catch(() => ({}));
          const s = j?.settings || j || {};
          SETTINGS = {
            grade_fee: Number(s.grade_fee) || DEFAULT_SETTINGS.grade_fee,
            shipping : Number(s.shipping)  || DEFAULT_SETTINGS.shipping,
          };
        }
      } catch {}
      // paint shipping immediately
      document.querySelector('.js-ship')?.replaceChildren(document.createTextNode(money(SETTINGS.shipping)));
    }

    // ===== Hydrate bundle from URL or session (matches overlay expectations) =====
    const params = new URLSearchParams(location.search);
    const qSubs  = (params.get('subs') || '').trim();
    const qEmail = (params.get('email') || '').trim();
    const qInvId = (params.get('invoice_id') || '').trim();

    let bundle = {};
    if (qSubs) {
      const subs = qSubs.split(',').map(s => s.trim()).filter(Boolean).map(id => ({ submission_id: id }));
      bundle = { customer_email: qEmail || '', submissions: subs, groups: [], group_codes: [], invoice_id: qInvId || null };
    } else {
      try { bundle = JSON.parse(sessionStorage.getItem('psa:builder:bundle') || '{}'); } catch { bundle = {}; }
    }
    try { sessionStorage.removeItem('psa:builder:bundle'); } catch {}

    if (!bundle || !Array.isArray(bundle.submissions) || bundle.submissions.length === 0) {
      document.body.insertAdjacentHTML('beforeend','<div class="empty" style="padding:24px;">Nothing to build. <a href="/admin/billing.html">Back to Billing</a></div>');
      throw new Error('No builder bundle present');
    }

    // ===== Data helpers (copied from overlay) =====
    function normalizeCardRow(r){
      return {
        id         : r.id || r.card_id || r.uuid || null,
        submission : r.submission_id || r.submission_code || r.submission || '',
        date       : r.break_date || r.break_at || r.date_of_break || null,
        channel    : r.break_channel || r.channel || r.break || '',
        breakNo    : r.break_num || r.break_number || r.break_no || r.break_id || '',
        desc       : r.card_description || r.description || r.card || r.title || ''
      };
    }

    async function fetchCardsForSubs(subIds){
      if (!subIds.length) return [];
      const qs = new URLSearchParams({ subs: subIds.join(',') }).toString();
      try {
        const r = await fetch(`/api/admin/billing/cards-preview?${qs}`, { credentials:'same-origin' });
        const j = await r.json().catch(()=>({ rows: [] }));
        const rows = Array.isArray(j.rows) ? j.rows : [];
        return rows.map(normalizeCardRow);
      } catch { return []; }
    }

    let draftInvoiceId = bundle.invoice_id || null;
    let hasUnsavedChanges = false;

    async function loadPrefillForSubs(submissionIds){
      if (!submissionIds?.length) return { invoice_id: null, items: [] };
      const qs = new URLSearchParams();
      qs.set('subs', submissionIds.join(','));
      const em = (bundle.customer_email || '').trim();
      if (em) qs.set('email', em);              // ensures we grab the right draft
      if (draftInvoiceId) qs.set('invoice_id', String(draftInvoiceId));
      const r = await fetch(`/api/admin/billing/preview/prefill?${qs}`, { credentials:'same-origin' });
      if (!r.ok) return { invoice_id: null, items: [] };
      return r.json();
    }

    function applyPrefillToUI(prefill){
      if (!prefill || !Array.isArray(prefill.items) || !prefill.items.length) return;
      const map = new Map(prefill.items.map(it => [String(it.card_id), it]));
      document.querySelectorAll('#cardsTbody input.js-up').forEach(inp => {
        const id = String(inp.getAttribute('data-id') || '');
        const it = map.get(id);
        if (!it) return;
        const dollars = (Number(it.upcharge_cents || 0) / 100).toFixed(2);
        inp.value = dollars;
      });
      if (prefill.invoice_id) draftInvoiceId = prefill.invoice_id;
      recalcFromDOM();
    }

    // ===== Totals (identical to overlay) =====
    function updateTotals(gradeSum, upchargeSum){
      const ship = SETTINGS.shipping;
      const subtotal = gradeSum + upchargeSum;
      const total = subtotal + ship;
      document.querySelector('.js-subtotal')?.replaceChildren(document.createTextNode(money(subtotal)));
      document.querySelector('.js-total')?.replaceChildren(document.createTextNode(money(total)));
      document.querySelector('.js-ship')?.replaceChildren(document.createTextNode(money(ship)));
    }

    function recalcFromDOM(){
      const tb = $('#cardsTbody'); if (!tb) return;
      const rows = Array.from(tb.querySelectorAll('tr[data-row]'));
      const gradeSum = rows.length * SETTINGS.grade_fee;
      const upchargeSum = rows.reduce((sum, tr) => {
        const v = Number(tr.querySelector('.js-up')?.value || 0);
        return sum + (Number.isFinite(v) ? v : 0);
      }, 0);
      updateTotals(gradeSum, upchargeSum);
    }

    function setSaveEnabled(on){
      const ids = ['btnDraftSave', 'btnSaveDraft'];
      ids.forEach(id => { const b = $(id); if (b) b.disabled = !on; });
    }

    function collectUpcharges(){
      const items = [];
      document.querySelectorAll('#cardsTbody input.js-up').forEach(inp => {
        const cardId = inp.getAttribute('data-id');
        const dollars = Number(inp.value || 0);
        if (!cardId) return;
        if (!Number.isFinite(dollars)) return;
        items.push({ card_id: cardId, upcharge_cents: Math.round(dollars * 100) });
      });
      return items;
    }

    async function saveUpchargesToDB(){
      const email = (bundle.customer_email || '').trim();
      const items = collectUpcharges();
      if (!email) { alert('Missing customer email.'); return; }
      if (!items.length) { alert('Nothing to save.'); return; }

      const btn = $('#btnDraftSave') || $('#btnSaveDraft');
      if (btn) { btn.disabled = true; btn.textContent = 'Saving…'; }

      try {
        const res = await fetch(SAVE_UPCHARGES_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ customer_email: email, items, invoice_id: draftInvoiceId || null })
        });

        if (!res.ok) throw new Error(await res.text().catch(()=> 'Save failed'));

        const j = await res.json().catch(()=> ({}));
        if (j && j.invoice_id) draftInvoiceId = j.invoice_id;

        hasUnsavedChanges = false;
        if (btn) {
          btn.textContent = 'Saved ✓';
          setTimeout(() => { btn.textContent = 'Save'; btn.disabled = true; }, 900);
        }
      } catch (err) {
        console.error(err);
        if (btn) { btn.textContent = 'Save'; btn.disabled = false; }
        alert('Failed to save.');
      }
    }

    async function fillCardsTable(subIds, subsFallback){
      const tb = $('#cardsTbody'); const empty = $('#cardsEmpty');
      if (!tb) return;
      tb.innerHTML = '';

      let rows = await fetchCardsForSubs(subIds);

      if (!rows.length && Array.isArray(subsFallback)) {
        rows = subsFallback.flatMap(s => {
          const sid = s?.submission_id || s?.submission_code || '';
          const count = Number(s?.cards) || 0;
          return Array.from({ length: count }, (_, i) => ({
            id: null, submission: sid, date: null, channel: '', breakNo: (i+1), desc: ''
          }));
        });
      }

      if (!rows.length) {
        if (empty) empty.classList.remove('hide');
        updateTotals(0, 0);
        return;
      }
      if (empty) empty.classList.add('hide');

      tb.innerHTML = rows.map((r, idx) => `
        <tr data-row="${idx}" data-id="${esc(r.id || '')}">
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.submission)}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;">${esc(fmtDateISOish(r.date))}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.channel || '—')}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;text-align:right;white-space:nowrap;">${esc(String(r.breakNo || '—'))}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;overflow:hidden;text-overflow:ellipsis;">${esc(r.desc || '—')}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;text-align:right;white-space:nowrap;" class="js-grade">${money(SETTINGS.grade_fee)}</td>
          <td style="padding:6px 12px;border-top:1px solid #f1f5f9;text-align:right;">
            <input class="js-up" data-id="${esc(r.id || '')}" type="number" step="0.01" min="0" value="0.00" style="width:100px;text-align:right;" />
          </td>
        </tr>
      `).join('');

      // wire inputs
      tb.querySelectorAll('.js-up').forEach(inp => {
        inp.addEventListener('input', () => {
          hasUnsavedChanges = true;
          setSaveEnabled(true);
          recalcFromDOM();
        });
      });

      // summary counts
      document.querySelector('.js-card-count')?.replaceChildren(document.createTextNode(String(rows.length)));

      recalcFromDOM();
    }

    function updateHeaderChips(rows){
      const subs = (bundle.submissions || []).map(s=>s?.submission_id).filter(Boolean);
      const groups = Array.from(new Set((bundle.groups || bundle.group_codes || []).filter(Boolean)));
      setList(document.querySelector('.js-sub-list'), subs);
      setList(document.querySelector('.js-group-list'), groups);
      document.querySelector('.js-cust-email')?.replaceChildren(document.createTextNode(bundle.customer_email || ''));
      document.querySelector('.js-sub-count')?.replaceChildren(document.createTextNode(String(subs.length)));

      const rngEl = document.querySelector('.js-range');
      if (rngEl){
        const ds = rows.map(r => new Date(r.date)).filter(d => !Number.isNaN(d.getTime()));
        if (ds.length){
          const minD = new Date(Math.min(...ds));
          const maxD = new Date(Math.max(...ds));
          rngEl.textContent = `Received ${fmtDateISOish(minD)} – ${fmtDateISOish(maxD)}`;
        } else {
          rngEl.textContent = '';
        }
      }
    }

    // ===== Init (same flow as overlay, but as a page) =====
    (async function init(){
      await loadSettings();

      const subs = (bundle.submissions || []).map(s => s?.submission_id).filter(Boolean);
      updateHeaderChips([]); // paint static bits

      // initial totals estimate based on known counts (like overlay)
      const estCards =
        (bundle.cards != null) ? Number(bundle.cards)
        : (bundle.submissions || []).reduce((a,s)=>a+(Number(s?.cards)||0),0);
      updateTotals(estCards * SETTINGS.grade_fee, 0);

      // fetch rows + render
      const rows = await fetchCardsForSubs(subs);
      await fillCardsTable(subs, bundle.submissions);
      updateHeaderChips(rows);

      // prefill saved upcharges (email + invoice guard)
      try {
        const pre = await loadPrefillForSubs(subs);
        applyPrefillToUI(pre);
      } catch {}

      // hook Save buttons
      $('#btnDraftSave')?.addEventListener('click', saveUpchargesToDB);
      $('#btnSaveDraft')?.addEventListener('click', saveUpchargesToDB);

      // leave warning if dirty
      window.addEventListener('beforeunload', (e) => {
        if (!hasUnsavedChanges) return;
        e.preventDefault();
        e.returnValue = '';
      });
    })();
  </script>
</body>
</html>
