<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSA Admin – Invoice Builder</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
</head>
<body>
  <div id="shell">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a class="sidebar-item" href="/admin/index.html">Active submissions</a>
        <a class="sidebar-item" href="/admin/groups.html">Groups</a>
        <a class="sidebar-item" href="/admin/billing.html">Billing</a>
        <a class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a class="sidebar-item" href="#" title="Coming soon">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <!-- Top bar -->
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <strong>Invoice Builder</strong>
          </div>
          <div class="top-actions" style="display:flex;gap:8px;align-items:center;">
            <a class="btn" href="/admin/billing.html">← Back to Billing</a>
            <button id="btnSaveDraft" class="btn" type="button" title="Coming soon" disabled>Save Draft</button>
            <button id="btnSend" class="btn primary" type="button" title="Coming soon" disabled>Send</button>
          </div>
        </div>

        <!-- Header/controls -->
        <div class="toolbar" style="gap:12px;align-items:flex-start;flex-wrap:wrap;">
          <div style="min-width:280px;">
            <div class="muted" style="font-size:12px;">Customer</div>
            <div id="b-email" style="font-weight:600;">—</div>
          </div>

          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <div>
              <div class="muted" style="font-size:12px;">Submissions</div>
              <div id="b-subs" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
            </div>
            <div>
              <div class="muted" style="font-size:12px;">Groups</div>
              <div id="b-groups" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
            </div>
          </div>

          <div class="spacer"></div>

          <div style="border:1px solid #eee;border-radius:12px;padding:12px;min-width:280px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <div>Shipping</div>
              <div>
                <input id="shipInput" type="number" step="0.01" min="0" value="5.00" style="width:96px;text-align:right;" />
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #eee;font-weight:700;">
              <div>Total (preview)</div>
              <div id="grandTotal">$—</div>
            </div>
            <div class="muted" style="font-size:12px;margin-top:8px;">Tax will be calculated by Shopify on save.</div>
          </div>
        </div>

        <!-- Cards table -->
        <div class="table-wrap" style="margin-top:8px;">
          <div class="table-scroller">
            <table class="table">
              <thead>
                <tr>
                  <th>Submission</th>
                  <th>Date of break</th>
                  <th>Break channel</th>
                  <th>Break #</th>
                  <th>Card description</th>
                  <th style="text-align:right;">Upcharge ($)</th>
                </tr>
              </thead>
              <tbody id="builderTbody"></tbody>
            </table>
          </div>
          <div id="emptyMsg" class="empty hide">No card rows to show.</div>
        </div>

        <div class="pagination"></div>
      </main>
    </div>
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);

    // Sign out
    document.getElementById('sidebar-signout')?.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await fetch('/api/admin-logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
      window.location.replace('/admin');
    });

    // Utils
    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function fmtDateISOish(v){
      if (!v) return '—';
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) {
        const s = String(v);
        return s.length >= 10 ? s.slice(0, 10) : s;
      }
      return d.toISOString().slice(0, 10);
    }
    function money(n){ const x = Number(n); return Number.isFinite(x) ? x.toLocaleString(undefined, { style:'currency', currency:'USD' }) : '$—'; }

// === HYDRATE from URL (preferred), fallback to sessionStorage ===
const params = new URLSearchParams(location.search);
const qSubs  = (params.get('subs') || '').trim();           // "psa-205,psa-206"
const qEmail = (params.get('email') || '').trim();
const qInvId = (params.get('invoice_id') || '').trim();

let bundle = {};
if (qSubs) {
  const subs = qSubs.split(',').map(s => s.trim()).filter(Boolean)
                    .map(id => ({ submission_id: id }));
  bundle = {
    customer_email: qEmail || '',
    submissions   : subs,
    groups        : [],
    group_codes   : [],
    invoice_id    : qInvId || null
  };
} else {
  // Fallback for older flows
  try { bundle = JSON.parse(sessionStorage.getItem('psa:builder:bundle') || '{}'); }
  catch { bundle = {}; }
}

if (!bundle || !Array.isArray(bundle.submissions) || bundle.submissions.length === 0) {
  document.body.insertAdjacentHTML(
    'beforeend',
    '<div class="empty" style="padding:24px;">Nothing to build. <a href="/admin/billing.html">Back to Billing</a></div>'
  );
  throw new Error('No builder bundle present');
}
// === END HYDRATE ===
try { sessionStorage.removeItem('psa:builder:bundle'); } catch {}
let draftInvoiceId = bundle.invoice_id || null;

    // Header render (email, chips)
    (function renderHeader(){
      const subs   = (bundle.submissions || []).map(s => s?.submission_id).filter(Boolean);
      const groups = Array.from(new Set((bundle.groups || bundle.group_codes || []).filter(Boolean)));

      const emailEl = $('#b-email'); if (emailEl) emailEl.textContent = bundle.customer_email || '—';

      const sWrap = $('#b-subs');
      if (sWrap) {
        sWrap.innerHTML = '';
        subs.forEach(x => {
          const sp = document.createElement('span');
          sp.className = 'pill';
          sp.style.padding = '4px 8px';
          sp.textContent = x;
          sWrap.appendChild(sp);
        });
      }

      const gWrap = $('#b-groups');
      if (gWrap) {
        gWrap.innerHTML = '';
        groups.forEach(x => {
          const sp = document.createElement('span');
          sp.className = 'pill';
          sp.style.padding = '4px 8px';
          sp.textContent = x;
          gWrap.appendChild(sp);
        });
      }
    })();
async function loadPrefillForBuilder(subIds){
  const qs = new URLSearchParams();
  if (draftInvoiceId) qs.set('invoice_id', String(draftInvoiceId));
  else if (Array.isArray(subIds) && subIds.length) qs.set('subs', subIds.join(','));

  // ✅ add this so prefill can locate the correct draft
  const em = (bundle.customer_email || '').trim();
  if (em) qs.set('email', em);

  if (![...qs.keys()].length) return { invoice_id: null, items: [] };

  try {
    const r = await fetch(`/api/admin/billing/preview/prefill?${qs}`, { credentials:'same-origin' });
    if (!r.ok) return { invoice_id: null, items: [] };
    return await r.json();
  } catch {
    return { invoice_id: null, items: [] };
  }
}


// Merge saved values into state.rows (match on card_id/id)
function applyPrefillToState(prefill){
  if (!prefill || !Array.isArray(prefill.items) || !prefill.items.length) return;
  const m = new Map(prefill.items.map(it => [ String(it.card_id), Number(it.upcharge_cents || 0) / 100 ]));
  state.rows = state.rows.map(r => {
    const key = String(r.id || r.card_id || r.uuid || r.cardId || '');
    const saved = m.get(key);
    return saved != null ? { ...r, __upcharge: saved } : r;
  });
  if (prefill.invoice_id) draftInvoiceId = prefill.invoice_id;
}

    // Fetch rows for submissions
    async function fetchCardsForSubs(subIds){
      if (!subIds.length) return [];
      const qs = new URLSearchParams({ subs: subIds.join(',') }).toString();
      try {
        const r = await fetch(`/api/admin/billing/cards-preview?${qs}`, { credentials:'same-origin' });
        const j = await r.json().catch(()=>({ rows: [] }));
        return Array.isArray(j.rows) ? j.rows : [];
      } catch { return []; }
    }

    // Local state
    const state = { rows: [], ship: 5.00 };
    window.__builderState = state; // expose for console debugging
    let isDirty = false;

function setDirty(on = true){
  isDirty = !!on;
  const b = $('#btnSaveDraft');
  if (b) b.disabled = !isDirty;
}

    window.addEventListener('beforeunload', (e) => {
  if (!isDirty) return;
  e.preventDefault();
  e.returnValue = '';
});

function collectItemsFromState(){
  // Only rows with a resolvable card id are saved
  return state.rows
    .map(r => {
      const id = r.id || r.card_id || r.uuid || r.cardId;
      if (!id) return null;
      const dollars = Number(r.__upcharge || 0);
      return {
        card_id: String(id),
        upcharge_cents: Math.round((Number.isFinite(dollars) ? dollars : 0) * 100)
      };
    })
    .filter(Boolean);
}

async function saveBuilderToDB(){
  const email = (bundle.customer_email || '').trim();
  const items = collectItemsFromState();

  if (!email) { alert('Missing customer email.'); return; }
  if (!items.length) { alert('Nothing to save.'); return; }

  const btn = $('#btnSaveDraft');
  if (btn) { btn.disabled = true; btn.textContent = 'Saving…'; }

  try {
    const res = await fetch('/api/admin/billing/preview/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
body: JSON.stringify({
  customer_email: email,
  items,
  invoice_id: draftInvoiceId || null,
  shipping_cents: Math.round((Number(state.ship) || 0) * 100)
})
    });

    if (!res.ok) throw new Error(await res.text().catch(()=> 'Save failed'));

    const j = await res.json().catch(()=> ({}));
    if (j && j.invoice_id) draftInvoiceId = j.invoice_id;

    setDirty(false);
    if (btn) {
      btn.textContent = 'Saved ✓';
      setTimeout(() => { btn.textContent = 'Save Draft'; btn.disabled = true; }, 900);
    }
  } catch (err) {
    console.error(err);
    if (btn) { btn.textContent = 'Save Draft'; btn.disabled = false; }
    alert('Failed to save draft.');
  }
}
    function recompute(){
      const upTotal = state.rows.reduce((a,r)=>a + (Number(r.__upcharge)||0), 0);
      const total = upTotal + (Number(state.ship) || 0);
      const gt = $('#grandTotal'); if (gt) gt.textContent = money(total);
    }

function renderRows(rows){
  const tb = document.getElementById('builderTbody');
  const empty = document.getElementById('emptyMsg');
  if (!tb) return;

  // Empty-state
  if (!Array.isArray(rows) || rows.length === 0) {
    if (empty) empty.classList.remove('hide');
    tb.replaceChildren();
    recompute();
    return;
  }
  if (empty) empty.classList.add('hide');

  // Build rows as real DOM nodes
  const frag = document.createDocumentFragment();
  rows.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(r.submission_id || r.submission_code || r.submission || '')}</td>
      <td>${esc(fmtDateISOish(r.break_date || r.break_at || r.date_of_break))}</td>
      <td>${esc(r.break_channel || r.channel || r.break || '')}</td>
      <td style="text-align:right;">${esc(String(r.break_number || r.break_num || r.break_no || r.break_id || ''))}</td>
      <td>${esc(r.card_description || r.description || r.card || r.title || '')}</td>
      <td style="text-align:right;">
        <input data-idx="${i}" class="up-inp" type="number" step="0.01" min="0"
               value="${Number(r.__upcharge || 0).toFixed(2)}"
               style="width:96px;text-align:right;" />
      </td>
    `;
    frag.appendChild(tr);
  });

  tb.replaceChildren(frag);

  // Wire inputs
  tb.querySelectorAll('.up-inp').forEach(inp => {
    inp.addEventListener('input', (e) => {
      const idx = Number(e.currentTarget.dataset.idx);
      const v = Number(e.currentTarget.value || 0);
      window.__builderState.rows[idx].__upcharge = Number.isFinite(v) ? v : 0;
      setDirty(true);
      recompute();
    });
  });

  recompute();
}

// Init
(async function init(){
  const shipEl = $('#shipInput');
  if (shipEl) {
    state.ship = Number(shipEl.value || 5.00) || 0;
    recompute();
    shipEl.addEventListener('input', ()=>{
      state.ship = Number(shipEl.value || 0) || 0;
      setDirty(true);
      recompute();
    });
  }

// load rows first (defensive + instrumented)
const subs = (bundle.submissions || [])
  .map(s => s?.submission_id)
  .filter(Boolean);

const rows = await fetchCardsForSubs(subs);
console.log('[builder] fetched rows:', Array.isArray(rows) ? rows.length : '(not array)');

state.rows = Array.isArray(rows) ? rows.map(r => ({ ...r, __upcharge: 0 })) : [];

// then hydrate from DB (safe)
const pre = await loadPrefillForBuilder(subs);
applyPrefillToState(pre);
if (pre && pre.shipping_cents != null) {
  state.ship = Number(pre.shipping_cents) / 100;
  const s = $('#shipInput'); if (s) s.value = state.ship.toFixed(2);
  recompute();
}

// render
renderRows(state.rows);

// HARD CHECK: if nothing painted, drop a small debug row so we know this code path ran
const tb = document.getElementById('builderTbody');
if (tb && !tb.querySelector('tr')) {
  tb.innerHTML = `<tr><td colspan="6" style="padding:12px;text-align:center;color:#6b7280;">
    debug (init): cards-preview returned ${state.rows.length} rows
  </td></tr>`;
}

})();
const saveBtn = $('#btnSaveDraft');
if (saveBtn) {
  saveBtn.addEventListener('click', saveBuilderToDB);
  saveBtn.disabled = true; // stays disabled until something changes
}
  </script>
</body>
</html>
