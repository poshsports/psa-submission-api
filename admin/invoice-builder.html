<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSA Admin – Invoice Builder</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
</head>
<body>
  <div id="shell">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a class="sidebar-item" href="/admin/index.html">Active submissions</a>
        <a class="sidebar-item" href="/admin/groups.html">Groups</a>
        <a class="sidebar-item active" href="/admin/billing.html">Billing</a>
        <a class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a class="sidebar-item" href="#" title="Coming soon">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <!-- Top bar -->
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <strong>Invoice Builder</strong>
          </div>
          <div class="top-actions" style="display:flex;gap:8px;align-items:center;">
            <a class="btn" href="/admin/billing.html">← Back to Billing</a>
            <button id="btnSave" class="btn" type="button" disabled>Save</button>
            <button id="btnSend" class="btn primary" type="button" title="Coming soon" disabled>Send</button>
          </div>
        </div>

        <!-- Header -->
        <div style="padding:12px 16px;">
          <div style="font-weight:700;margin-bottom:6px;">Draft Invoice Preview</div>
          <div class="muted" style="font-size:12px;margin-bottom:10px;">
            <span class="js-cust-email"></span> ·
            <span class="js-sub-count">0</span> submissions ·
            <span class="js-card-count">0</span> cards
          </div>

          <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start;">
            <!-- left -->
            <div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div style="border:1px solid #eee;border-radius:12px;padding:10px;">
                  <div style="font-weight:600;margin-bottom:6px;">Submissions</div>
                  <div class="js-sub-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                </div>
                <div style="border:1px solid #eee;border-radius:12px;padding:10px;">
                  <div style="font-weight:600;margin-bottom:6px;">Groups</div>
                  <div class="js-group-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                </div>
              </div>
              <div class="js-range muted" style="margin-top:8px;font-size:12px;"></div>
            </div>

            <!-- right summary -->
            <div>
              <div style="border:1px solid #eee;border-radius:12px;padding:12px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                  <div>Subtotal (est.)</div>
                  <div class="js-subtotal">$—</div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                  <div>Shipping (flat)</div>
                  <div class="js-ship">$5.00</div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #eee;font-weight:700;">
                  <div>Total (est.)</div>
                  <div class="js-total">$—</div>
                </div>
                <div class="muted" style="font-size:12px;margin-top:8px;">Tax will be calculated by Shopify on save.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cards -->
        <div style="padding:0 16px 16px 16px; display:flex; flex-direction:column; gap:8px;">
          <div style="font-weight:600;">Cards</div>
          <div class="cards-wrap" style="border:1px solid #eee;border-radius:12px; flex:1 1 auto; min-height:200px; overflow:auto; overscroll-behavior:contain;">
            <table class="cards-table" style="width:100%;min-width:960px;border-collapse:separate;border-spacing:0;table-layout:fixed;">
              <colgroup>
                <col style="width:140px;">
                <col style="width:120px;">
                <col style="width:160px;">
                <col style="width:110px;">
                <col style="width:auto;">
                <col style="width:120px;">
                <col style="width:140px;">
              </colgroup>
              <thead>
                <tr>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Submission</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Date of break</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Break channel</th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Break #</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Card description</th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Grading ($)</th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1;background:#f8fafc;">Upcharge ($)</th>
                </tr>
              </thead>
              <tbody id="cardsTbody"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    // ---------- tiny utils ----------
    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const money = (n) => {
      const x = Number(n);
      return Number.isFinite(x) ? x.toLocaleString(undefined, { style:'currency', currency:'USD' }) : '$—';
    };
    const esc = (s) => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const fmtDateISOish = (v) => {
      if (!v) return '—';
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) { const s = String(v); return s.length >= 10 ? s.slice(0,10) : s; }
      return d.toISOString().slice(0,10);
    };

    // ---------- constants & state ----------
    const GRADE_FEE = 20.00;     // flat per-card grading (adjust if needed)
    const SHIPPING  = 5.00;      // flat shipping shown in the summary
    const PREFILL_URL = '/api/admin/billing/preview/prefill';
    const CARDS_URL   = '/api/admin/billing/cards-preview';
    const SAVE_URL    = '/api/admin/billing/preview/save';

    const state = { rows: [], ship: SHIPPING };
    let draftInvoiceId = (qs.get('invoice_id') || '').trim() || null;
    const bundle = (() => {
      const subs = (qs.get('subs') || '')
        .split(',').map(s => s.trim()).filter(Boolean)
        .map(id => ({ submission_id: id }));
      return {
        customer_email: (qs.get('email') || '').trim(),
        submissions: subs,
        groups: [],
        group_codes: [],
        invoice_id: draftInvoiceId
      };
    })();

    // ---------- header chips ----------
    function pill(text){
      const span = document.createElement('span');
      span.textContent = text;
      span.style.display='inline-block';
      span.style.padding='4px 8px';
      span.className='pill';
      return span;
    }
    function updateHeader(){
      const emailEl = document.querySelector('.js-cust-email');
      const subCtEl = document.querySelector('.js-sub-count');
      const cardCtEl= document.querySelector('.js-card-count');
      if (emailEl) emailEl.textContent = bundle.customer_email || '—';
      if (subCtEl) subCtEl.textContent = String((bundle.submissions||[]).length);
      if (cardCtEl) cardCtEl.textContent = String(state.rows.length);

      const subList = document.querySelector('.js-sub-list');
      const grpList = document.querySelector('.js-group-list');
      if (subList){
        subList.innerHTML=''; (bundle.submissions||[]).forEach(s=> subList.appendChild(pill(s.submission_id)));
      }
      if (grpList){
        grpList.innerHTML=''; (bundle.group_codes||bundle.groups||[]).forEach(g=> grpList.appendChild(pill(g)));
      }

      const rngEl = document.querySelector('.js-range');
      if (rngEl){
        const ds = state.rows.map(r => new Date(r.break_date || r.break_at || r.date_of_break))
                             .filter(d => !Number.isNaN(d.getTime()));
        if (ds.length){
          const minD = new Date(Math.min(...ds));
          const maxD = new Date(Math.max(...ds));
          rngEl.textContent = `Received ${fmtDateISOish(minD)} – ${fmtDateISOish(maxD)}`;
        } else {
          rngEl.textContent = '';
        }
      }
    }

    // ---------- totals ----------
    function recompute(){
      const grade = state.rows.length * GRADE_FEE;
      const up    = state.rows.reduce((a,r)=> a + (Number(r.__upcharge)||0), 0);
      const sub   = grade + up;
      const tot   = sub + state.ship;

      const st = document.querySelector('.js-subtotal');
      const sh = document.querySelector('.js-ship');
      const gt = document.querySelector('.js-total');
      if (st) st.textContent = money(sub);
      if (sh) sh.textContent = money(state.ship);
      if (gt) gt.textContent = money(tot);
    }

    // ---------- data fetch ----------
    function normalizeRow(r){
      const cents =
        r.upcharge_cents ??
        r.suggested_upcharge_cents ??
        r.prefill_upcharge_cents ??
        null;

      const dollars = r.upcharge != null
        ? Number(r.upcharge)
        : (cents != null ? Number(cents) / 100 : 0);

      return {
        id: r.id || r.card_id || r.uuid || r.cardId || null,
        submission: r.submission_id || r.submission_code || r.submission || '',
        break_date: r.break_date || r.break_at || r.date_of_break || null,
        channel: r.break_channel || r.channel || r.break || '',
        break_no: r.break_number || r.break_num || r.break_no || r.break_id || '',
        desc: r.card_description || r.description || r.card || r.title || '',
        __upcharge: Number.isFinite(dollars) ? dollars : 0
      };
    }

    async function fetchCardsForSubs(subIds){
      if (!subIds.length) return { ok:true, rows: [] };
      const url = `${CARDS_URL}?${new URLSearchParams({ subs: subIds.join(',') })}`;
      try {
        const res = await fetch(url, { credentials:'same-origin' });
        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          return { ok:false, status:res.status, text:t };
        }
        const j = await res.json().catch(()=> ({ rows: [] }));
        const rows = Array.isArray(j.rows) ? j.rows.map(normalizeRow) : [];
        return { ok:true, rows };
      } catch (e) {
        return { ok:false, status:'network', text:String(e||'error') };
      }
    }

    async function loadPrefill(subIds){
      const qp = new URLSearchParams();
      if (draftInvoiceId) qp.set('invoice_id', String(draftInvoiceId));
      else if (subIds.length) qp.set('subs', subIds.join(','));
      const em = (bundle.customer_email||'').trim(); if (em) qp.set('email', em);
      if (![...qp.keys()].length) return { invoice_id:null, items:[] };

      try{
        const r = await fetch(`${PREFILL_URL}?${qp.toString()}`, { credentials:'same-origin' });
        if (!r.ok) return { invoice_id:null, items:[] };
        return await r.json();
      } catch { return { invoice_id:null, items:[] }; }
    }

    function applyPrefill(prefill){
      if (!prefill || !Array.isArray(prefill.items) || !prefill.items.length) return;
      const toDol = (c) => Number.isFinite(Number(c)) ? Number(c)/100 : 0;
      const map = new Map(prefill.items.map(it => {
        const dollars =
          toDol(it.upcharge_cents ?? it.suggested_upcharge_cents ?? it.prefill_upcharge_cents) ||
          (Number.isFinite(Number(it.upcharge)) ? Number(it.upcharge) : 0);
        return [ String(it.card_id), dollars ];
      }));
      state.rows = state.rows.map(r => {
        const saved = map.get(String(r.id || ''));
        return saved != null ? { ...r, __upcharge: saved } : r;
      });
      if (prefill.invoice_id) draftInvoiceId = prefill.invoice_id;
    }

    // ---------- render ----------
    function renderRows(){
      const tb = $('cardsTbody');
      if (!tb) return;
      tb.innerHTML = '';

      if (!state.rows.length){
        tb.innerHTML = '<tr><td colspan="7" style="padding:12px;text-align:center;color:#6b7280;">No card rows to show.</td></tr>';
        recompute(); updateHeader();
        return;
      }

      const frag = document.createDocumentFragment();
      state.rows.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-row', String(i));
        tr.innerHTML = `
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.submission)}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;">${esc(fmtDateISOish(r.break_date))}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.channel || '—')}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;text-align:right;white-space:nowrap;">${esc(String(r.break_no || '—'))}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;overflow:hidden;text-overflow:ellipsis;">${esc(r.desc || '—')}</td>
          <td style="padding:8px 12px;border-top:1px solid #f1f5f9;text-align:right;white-space:nowrap;" class="js-grade">${money(GRADE_FEE)}</td>
          <td style="padding:6px 12px;border-top:1px solid #f1f5f9;text-align:right;">
            <input class="up-inp" data-idx="${i}" data-id="${esc(r.id || '')}" type="number" step="0.01" min="0"
                   value="${Number(r.__upcharge || 0).toFixed(2)}"
                   style="width:96px;text-align:right;" ${r.id ? '' : 'disabled'} />
          </td>`;
        frag.appendChild(tr);
      });
      tb.appendChild(frag);

      // wire inputs
      tb.querySelectorAll('.up-inp').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const idx = Number(e.currentTarget.dataset.idx);
          const v = Number(e.currentTarget.value || 0);
          state.rows[idx].__upcharge = Number.isFinite(v) ? v : 0;
          $('#btnSave').disabled = false;
          recompute();
          updateHeader();
        });
      });

      recompute();
      updateHeader();
    }

    // ---------- save ----------
    function collectItems(){
      return state.rows.map(r => {
        const id = r.id;
        if (!id) return null;
        const dollars = Number(r.__upcharge || 0);
        return { card_id: String(id), upcharge_cents: Math.round((Number.isFinite(dollars) ? dollars : 0) * 100) };
      }).filter(Boolean);
    }

    async function saveDraft(){
      const email = (bundle.customer_email || '').trim();
      const items = collectItems();
      if (!email) { alert('Missing customer email.'); return; }
      if (!items.length) { alert('Nothing to save.'); return; }

      const btn = $('#btnSave');
      if (btn){ btn.disabled = true; btn.textContent = 'Saving…'; }

      try{
        const res = await fetch(SAVE_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          credentials:'same-origin',
          body: JSON.stringify({
            customer_email: email,
            items,
            invoice_id: draftInvoiceId || null,
            shipping_cents: Math.round((Number(state.ship) || 0) * 100)
          })
        });
        if (!res.ok) throw new Error(await res.text().catch(()=> 'Save failed'));
        const j = await res.json().catch(()=> ({}));
        if (j && j.invoice_id) draftInvoiceId = j.invoice_id;
        if (btn){
          btn.textContent = 'Saved ✓';
          setTimeout(() => { btn.textContent = 'Save'; btn.disabled = true; }, 900);
        }
      } catch (e){
        console.error(e);
        if (btn){ btn.textContent = 'Save'; btn.disabled = false; }
        alert('Failed to save draft.');
      }
    }

    // ---------- boot ----------
    (async function init(){
      // sign out
      document.getElementById('sidebar-signout')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await fetch('/api/admin-logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
        window.location.replace('/admin');
      });

      // show shipping immediately
      const shipEl = document.querySelector('.js-ship');
      if (shipEl) shipEl.textContent = money(state.ship);

      const subIds = (bundle.submissions || []).map(s => s?.submission_id).filter(Boolean);
      document.querySelector('.js-cust-email').textContent = bundle.customer_email || '—';
      document.querySelector('.js-sub-count').textContent = String(subIds.length);

      // 1) fetch rows
      const r = await fetchCardsForSubs(subIds);
      if (!r.ok){
        const tb = $('cardsTbody');
        tb.innerHTML = `<tr><td colspan="7" style="padding:12px;text-align:center;color:#b91c1c;">
          Failed to load cards-preview (${esc(String(r.status))}). ${esc(r.text || '')}
        </td></tr>`;
        recompute(); updateHeader();
        return;
      }
      state.rows = r.rows;

      // 2) hydrate from prefill (if any)
      const pre = await loadPrefill(subIds);
      applyPrefill(pre);

      // 3) render
      renderRows();

      // wire save
      $('#btnSave')?.addEventListener('click', saveDraft);
      $('#btnSave').disabled = true;
    })();
  </script>
</body>
</html>
