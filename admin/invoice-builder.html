<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSA Admin – Invoice Builder</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
</head>
<body>

  <!-- APP SHELL -->
  <div id="shell">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a id="nav-active"  class="sidebar-item" href="/admin/index.html">Active submissions</a>
        <a id="nav-groups"  class="sidebar-item" href="/admin/groups.html">Groups</a>
        <a id="nav-billing" class="sidebar-item" href="/admin/billing.html">Billing</a>
        <a id="nav-reports" class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a id="nav-settings" class="sidebar-item" href="/admin/settings.html">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <!-- Top bar -->
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <strong>Invoice Builder</strong>
          </div>
          <div class="top-actions">
            <a href="/admin/billing.html" class="btn">← Back to Billing</a>
            <button type="button" id="btnDraftSave" class="btn" style="min-width:120px;" disabled>Save</button>
            <button type="button" id="btnDraftSend" class="btn primary" style="min-width:120px;">Send</button>
          </div>
        </div>

        <!-- Body -->
        <div id="draftBody" style="padding:12px 16px; display:flex; flex-direction:column; gap:12px; overflow:hidden; flex:1 1 auto; min-height:0;">
          <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start;">
            <!-- Submissions + Groups -->
            <div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div style="border:1px solid #eee;border-radius:12px;padding:10px;">
                  <div style="font-weight:600;margin-bottom:6px;">Submissions</div>
                  <div class="js-sub-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                </div>
                <div style="border:1px solid #eee;border-radius:12px;padding:10px;">
                  <div style="font-weight:600;margin-bottom:6px;">Groups</div>
                  <div class="js-group-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                </div>
              </div>

              <!-- Email pill -->
              <div class="email-row" style="margin-top:8px;display:flex;align-items:center;gap:8px;">
                <div class="muted" style="font-size:12px;">Customer</div>
                <div class="js-email" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
              </div>

              <!-- Ship-to (single address only) -->
              <div class="panel" id="shipToPanel"
                   style="border:1px solid #e6e8ec;border-radius:10px;padding:10px;margin-top:8px;background:#fbfbfc">
                <div style="font-weight:600;margin:0 0 6px;font-size:13px;">Ship-to</div>
                <div id="shipToBody" class="mono small"
                     style="white-space:pre-line;font-size:12px;line-height:1.35;">—</div>
              </div>

              <!-- Received range -->
              <div class="js-range muted" style="margin-top:4px;font-size:12px;"></div>
            </div>

            <!-- Summary -->
            <div>
              <div style="border:1px solid #eee;border-radius:12px;padding:12px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                  <div>Subtotal (est.)</div>
                  <div class="js-subtotal">$—</div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                  <div>Shipping (flat)</div>
                  <div class="js-ship">$5.00</div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #eee;font-weight:700;">
                  <div>Total (est.)</div>
                  <div class="js-total">$—</div>
                </div>
                <div class="muted" style="font-size:12px;margin-top:8px;">Tax will be calculated by Shopify on save.</div>
              </div>
            </div>
          </div>

          <!-- Cards table -->
          <div style="margin-top:12px; display:flex; flex-direction:column; flex:1 1 auto; min-height:0;">
            <div style="font-weight:600;margin-bottom:6px;">Cards</div>
            <div class="cards-wrap" style="border:1px solid #eee;border-radius:12px; flex:1 1 auto; min-height:0; overflow:auto; overscroll-behavior:contain;">
              <table class="cards-table" style="width:100%;min-width:960px;border-collapse:separate;border-spacing:0;table-layout:fixed;">
                <thead>
                  <tr>
                    <th>Submission</th>
                    <th>Date of break</th>
                    <th>Break channel</th>
                    <th style="text-align:right;">Break #</th>
                    <th>Card description</th>
                    <th style="text-align:right;">Grading ($)</th>
                    <th style="text-align:right;">Upcharge ($)</th>
                  </tr>
                </thead>
                <tbody id="cardsTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Confirm Close Modal -->
  <div id="confirmCloseModal" role="dialog" aria-modal="true"
       style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;
              background:rgba(0,0,0,0.35);z-index:1100;">
    <div style="width:min(460px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.25);padding:18px;">
      <div style="font-weight:700;font-size:16px;margin-bottom:6px;">Unsaved changes</div>
      <div class="muted" style="font-size:13px;margin-bottom:14px;">
        Do you want to save your changes before leaving?
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" id="btnConfirmCancel" class="btn">Cancel</button>
        <button type="button" id="btnConfirmDiscard" class="btn" style="background:#f1f5f9;">Discard</button>
        <button type="button" id="btnConfirmSave" class="btn primary">Save &amp; Leave</button>
      </div>
    </div>
  </div>

  <!-- Send Confirmation Modal -->
  <div id="sendConfirmModal" role="dialog" aria-modal="true"
       style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:1100;">
    <div style="width:min(520px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.25);padding:18px;">
      <div style="font-weight:700;font-size:16px;margin-bottom:6px;">Send invoice?</div>
      <div class="muted" style="font-size:13px;margin-bottom:12px;">
        <div><strong>Customer:</strong> <span id="sendEmailTarget">—</span></div>
        <div><strong>Cards:</strong> <span id="sendCardCount">0</span></div>
        <div><strong>Estimated total:</strong> <span id="sendEstTotal">$—</span></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" id="btnSendCancel" class="btn">Cancel</button>
        <button type="button" id="btnSendConfirm" class="btn primary">Confirm &amp; Send</button>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script type="module">
    const $ = (id) => document.getElementById(id);
    const DEFAULT_SETTINGS = { grade_fee: 20.00, shipping: 5.00 };
    let SETTINGS = { ...DEFAULT_SETTINGS };
    const SAVE_ENDPOINT  = '/api/admin/billing/preview/save';
    const SEND_ENDPOINT  = '/api/admin/billing/send-invoice';

    let draftInvoiceId      = null;
    let hasUnsavedChanges   = false;
    let lastBundle          = null;
    let pendingNavHref      = null; // for dirty-leave modal

    async function loadSettings() {
      try {
        const r = await fetch('/api/admin/settings', { credentials: 'same-origin' });
        if (r.ok) {
          const j = await r.json().catch(() => ({}));
          const s = j?.settings || j || {};
          SETTINGS = {
            grade_fee: Number(s.grade_fee) || DEFAULT_SETTINGS.grade_fee,
            shipping : Number(s.shipping)  || DEFAULT_SETTINGS.shipping,
          };
        }
      } catch {}
    }

    function money(n) {
      const x = Number(n);
      return Number.isFinite(x)
        ? x.toLocaleString(undefined, { style: 'currency', currency: 'USD' })
        : '$—';
    }

    function esc(s) {
      return String(s == null ? "" : s).replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }

    // Map PSA service → cents (fallback to default grade fee if unknown)
    function priceCentsForService(name) {
      const n = String(name || "").trim().toLowerCase();
      const map = new Map([
        ["psa value bulk", 2800],
        ["psa value", 3500],
        ["psa regular", 8500],
        // add others here as needed
      ]);
      if (map.has(n)) return map.get(n);
      return Math.round((Number(SETTINGS?.grade_fee ?? 20) || 20) * 100);
    }

    function pill(text) {
      const span = document.createElement("span");
      span.textContent = text;
      span.style.display = "inline-block";
      span.style.padding = "4px 8px";
      span.style.border = "1px solid #e5e7eb";
      span.style.borderRadius = "999px";
      span.style.fontSize = "12px";
      span.style.background = "#f8fafc";
      return span;
    }

    function emailPill(text) {
      const span = pill(text);
      span.style.background = "#eef2ff";
      span.style.border     = "1px solid #c7d2fe";
      span.style.fontWeight = "600";
      return span;
    }

    // ---- Ship-to formatting (single address) ----
    function formatShipTo(a) {
      if (!a) return '—';
      const name   = a.name   || a.contact || a.full_name || '';
      const line1  = a.line1  || a.address1 || a.addr1 || a.street || '';
      const line2  = a.line2  || a.address2 || a.addr2 || '';
      const city   = a.city   || '';
      const region = a.region || a.state || a.province || '';
      const postal = a.postal || a.zip || a.postal_code || '';
      const country= a.country|| 'US';

      const lines = [
        name,
        line1,
        line2,
        [city, region, postal].filter(Boolean).join(', '),
        country
      ].filter(Boolean);

      return lines.length ? lines.join('\n') : '—';
    }

    function renderShipToSingle(shipTo) {
      const body = document.getElementById('shipToBody');
      if (!body) return;
      body.textContent = formatShipTo(shipTo);
    }

    // ---- Card rows ----
    function normalizeCardRow(r) {
      return {
        id:         r.id || r.card_id || r.uuid || null,
        submission: r.submission_id || r.submission_code || r.submission || "",
        date:       r.break_date || r.break_at || r.date_of_break || null,
        channel:    r.break_channel || r.channel || r.break || "",
        breakNo:    r.break_num || r.break_number || r.break_no || r.break_id || "",
        desc:       r.card_description || r.description || r.card || r.title || "",
        service:    r.grading_service || "",
        grading_cents: Number(r.grading_amount ?? r.grading_cents ?? 0)
                        || priceCentsForService(r.grading_service)
      };
    }

    async function fetchCardsForSubs(subIds) {
      if (!subIds.length) return [];
      const qs = new URLSearchParams({ subs: subIds.join(",") }).toString();
      const r  = await fetch(`/api/admin/billing/cards-preview?${qs}`, { credentials:"same-origin" });
      const j  = await r.json().catch(() => ({ rows: [] }));
      return (j.rows || []).map(normalizeCardRow);
    }

    // ---- Prefill from existing draft ----
    async function loadPrefill(submissionIds) {
      if (!submissionIds?.length) return { invoice_id: null, items: [] };

      const subsParam  = encodeURIComponent(submissionIds.join(','));
      const emailParam = encodeURIComponent((lastBundle?.customer_email || '').trim());
      let url = `/api/admin/billing/preview/prefill?subs=${subsParam}&email=${emailParam}`;

      // If we have a ship_to in the bundle, pass it along (helps pick correct invoice if any)
      if (lastBundle?.ship_to) {
        url += `&ship_to=${encodeURIComponent(JSON.stringify(lastBundle.ship_to))}`;
      }

      const r = await fetch(url, { credentials: 'same-origin' });
      if (!r.ok) return { invoice_id: null, items: [] };
      return r.json();
    }

    function applyPrefill(prefill) {
      if (!prefill?.items?.length) return;
      const map = new Map(prefill.items.map(it => [String(it.card_id), it]));
      document.querySelectorAll('#cardsTbody input.js-up').forEach(inp => {
        const id = String(inp.dataset.id || '');
        const it = map.get(id);
        if (it) inp.value = (Number(it.upcharge_cents || 0) / 100).toFixed(2);
      });
      draftInvoiceId = prefill.invoice_id || null;
      recalc();
    }

    // Ensure a draft exists once rows are present (silent)
    async function ensureDraftExists() {
      if (draftInvoiceId) return;
      const email = (lastBundle?.customer_email || '').trim();
      if (!email) return;

      const items = collectUpcharges();
      if (!items.length) return;

      await save(true);
    }

    // ---- Totals ----
    function updateTotals(gradeSum, upchargeSum) {
      const ship     = SETTINGS.shipping;
      const subtotal = gradeSum + upchargeSum;
      const total    = subtotal + ship;

      document.querySelector(".js-subtotal").textContent = money(subtotal);
      document.querySelector(".js-total").textContent    = money(total);
      document.querySelector(".js-ship").textContent     = money(ship);
    }

    function recalc() {
      const rows = [...document.querySelectorAll("#cardsTbody tr[data-row]")];
      const gradeSum = rows.reduce((s, tr) =>
        s + (Number(tr.dataset.gradeCents || 0) / 100), 0
      );
      const upchargeSum = rows.reduce((s, tr) =>
        s + Number(tr.querySelector(".js-up")?.value || 0), 0
      );
      updateTotals(gradeSum, upchargeSum);
    }

    function collectUpcharges() {
      return [...document.querySelectorAll('#cardsTbody input.js-up')]
        .map(inp => {
          const id = inp.dataset.id;
          const v  = Number(inp.value || 0);
          return id && Number.isFinite(v)
            ? { card_id: id, upcharge_cents: Math.round(v * 100) }
            : null;
        })
        .filter(Boolean);
    }

    // ---- Save ----
    async function save(silent = false) {
      const email = (lastBundle?.customer_email || '').trim();
      const items = collectUpcharges();
      if (!email || !items.length) return;

      const btn = $("btnDraftSave");
      if (!silent && btn) { btn.disabled = true; btn.textContent = 'Saving…'; }

      const body = {
        customer_email: email,
        items,
        invoice_id: draftInvoiceId || null,
      };

      // If we have a single ship-to, let the server persist it on the invoice
      if (lastBundle?.ship_to) {
        body.ship_to = lastBundle.ship_to;
      }

      const res = await fetch(SAVE_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(body)
      });

      if (res.ok) {
        const j = await res.json().catch(() => ({}));
        if (j && j.invoice_id) draftInvoiceId = j.invoice_id;
        hasUnsavedChanges = false;

        if (!silent && btn) {
          btn.textContent = 'Saved ✓';
          setTimeout(() => { btn.textContent = 'Save'; btn.disabled = true; }, 1200);
        }
      } else {
        const txt = await res.text().catch(() => '');
        console.error('[preview/save] failed:', txt);
        if (!silent) alert('Save failed.\n' + (txt || ''));
        if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
      }
    }

    // ---- Send ----
    async function sendInvoice() {
      const email = (lastBundle?.customer_email || '').trim();
      const btn   = $("btnDraftSend");

      if (!email) { alert('Missing customer email.'); return; }

      // Ensure latest changes are saved first
      if (hasUnsavedChanges) {
        await save(true);
        if (hasUnsavedChanges) return;
      }

      // Ensure we have an invoice id
      if (!draftInvoiceId) {
        await save(true);
        if (!draftInvoiceId) {
          alert('Could not determine invoice id.');
          return;
        }
      }

      try {
        btn.disabled = true;
        btn.textContent = 'Sending…';

        const res = await fetch(SEND_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            invoice_id: draftInvoiceId,
            customer_email: email
          })
        });

        if (!res.ok) {
          const t = await res.text().catch(() => '');
          console.error('Send failed', t);
          alert('Failed to send invoice.');
          btn.disabled = false;
          btn.textContent = 'Send';
          return;
        }

        hasUnsavedChanges = false;
        window.location.href = '/admin/billing.html';
      } catch (err) {
        console.error(err);
        alert('Failed to send invoice.');
        btn.disabled = false;
        btn.textContent = 'Send';
      }
    }

    // ---- Modals ----
    function showConfirm(show) {
      const m = document.getElementById('confirmCloseModal');
      if (!m) return;
      m.style.display = show ? 'flex' : 'none';
      if (show) {
        (document.getElementById('btnConfirmSave') ||
         document.getElementById('btnConfirmCancel') || m).focus();
      }
    }

    function showSendConfirm(show) {
      const m = document.getElementById('sendConfirmModal');
      if (!m) return;
      m.style.display = show ? 'flex' : 'none';
      if (show) {
        const email = (lastBundle?.customer_email || '').trim() || '—';
        const rows  = [...document.querySelectorAll("#cardsTbody tr[data-row]")];
        const gradeSum = rows.reduce((s, tr) =>
          s + (Number(tr.dataset.gradeCents || 0) / 100), 0
        );
        const upchargeSum = rows.reduce((s, tr) =>
          s + Number(tr.querySelector(".js-up")?.value || 0), 0
        );
        const total = gradeSum + upchargeSum + SETTINGS.shipping;

        $("sendEmailTarget").textContent = email;
        $("sendCardCount").textContent   = String(rows.length);
        $("sendEstTotal").textContent    = money(total);
      }
    }

    function navigateToPending() {
      const href = pendingNavHref;
      pendingNavHref = null;
      if (href) window.location.href = href;
    }

    function installDirtyLeaveGuards() {
      // Tab close / reload
      window.addEventListener('beforeunload', (e) => {
        if (!hasUnsavedChanges) return;
        e.preventDefault();
        e.returnValue = '';
      });

      // Intercept anchor navigations
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[href]');
        if (!a) return;
        const href = a.getAttribute('href') || '';
        if (!href || href.startsWith('#') || href.startsWith('javascript:')) return;
        if (!hasUnsavedChanges) return;
        e.preventDefault();
        e.stopImmediatePropagation();
        pendingNavHref = href;
        showConfirm(true);
      });

      // Modal buttons
      const bSave    = document.getElementById('btnConfirmSave');
      const bDiscard = document.getElementById('btnConfirmDiscard');
      const bCancel  = document.getElementById('btnConfirmCancel');

      bCancel?.addEventListener('click', () => showConfirm(false));

      bDiscard?.addEventListener('click', () => {
        hasUnsavedChanges = false;
        showConfirm(false);
        navigateToPending();
      });

      bSave?.addEventListener('click', async () => {
        await save(false);
        if (!hasUnsavedChanges) {
          showConfirm(false);
          navigateToPending();
        }
      });

      // ESC closes confirm
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' &&
            document.getElementById('confirmCloseModal')?.style.display !== 'none') {
          showConfirm(false);
        }
      });
    }

    // ---- Populate UI ----
    async function populate(bundle) {
      lastBundle = bundle;
      const subs   = bundle.submissions || [];
      const groups = bundle.groups || bundle.group_codes || [];
      const email  = bundle.customer_email || '';

      // Submissions pills
      const subEl = document.querySelector(".js-sub-list");
      subEl.innerHTML = '';
      subs.forEach(s => subEl.appendChild(pill(s.submission_id)));

      // Groups pills
      const grpEl = document.querySelector(".js-group-list");
      grpEl.innerHTML = '';
      groups.forEach(code => grpEl.appendChild(pill(code)));

      // Email pill
      const emailEl = document.querySelector(".js-email");
      if (emailEl) {
        emailEl.innerHTML = "";
        emailEl.appendChild(email ? emailPill(email) : pill("—"));
      }

      // Ship-to (single)
      renderShipToSingle(bundle.ship_to || null);

      const subIds = subs.map(s => s.submission_id);
      const rows   = await fetchCardsForSubs(subIds);

      $("cardsTbody").innerHTML = rows.map((r, i) => `
        <tr data-row="${i}" data-grade-cents="${r.grading_cents || 0}">
          <td>${esc(r.submission)}</td>
          <td>${esc(r.date || '')}</td>
          <td>${esc(r.channel || '—')}</td>
          <td style="text-align:right;">${esc(r.breakNo || '—')}</td>
          <td>${esc(r.desc || '—')}</td>
          <td style="text-align:right;">${money((r.grading_cents || 0) / 100)}</td>
          <td style="text-align:right;">
            <input class="js-up" data-id="${esc(r.id || '')}"
                   type="number" step="0.01" value="0.00"
                   style="width:100px;text-align:right;" />
          </td>
        </tr>`).join("");

      $("cardsTbody").addEventListener("input", () => {
        hasUnsavedChanges = true;
        $("btnDraftSave").disabled = false;
        recalc();
      });

      recalc();

      const pre = await loadPrefill(subIds);
      applyPrefill(pre);

      await ensureDraftExists();
    }

    // ---- Boot ----
    (async function init() {
      $("sidebar-signout")?.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await fetch('/api/admin-logout', { method: 'POST', credentials: 'same-origin' });
        } catch {}
        window.location.replace('/admin');
      });

      await loadSettings();

      const qs      = new URLSearchParams(location.search);
      const subs    = (qs.get("subs") || "").split(",").filter(Boolean).map(id => ({ submission_id: id }));
      const groups  = (qs.get("groups") || "").split(",").filter(Boolean);
      const email   = qs.get("email") || "";

      let ship_to = null;
      const shipRaw = qs.get("ship_to");
      if (shipRaw) {
        try {
          ship_to = JSON.parse(shipRaw);
        } catch {}
      }

      const bundle = {
        customer_email: email,
        submissions: subs,
        groups,
        ship_to
      };

      await populate(bundle);

      $("btnDraftSave")?.addEventListener("click", () => save(false));
      $("btnConfirmSave")?.addEventListener("click", () => save(false));

      $("btnDraftSend")?.addEventListener("click", () => showSendConfirm(true));
      $("btnSendCancel")?.addEventListener("click", () => showSendConfirm(false));
      $("btnSendConfirm")?.addEventListener("click", async () => {
        showSendConfirm(false);
        await sendInvoice();
      });

      installDirtyLeaveGuards();
    })();
  </script>
</body>
</html>
