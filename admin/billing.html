<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSA Admin – Billing</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
</head>
<body>

  <!-- APP SHELL -->
  <div id="shell">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a id="nav-active"  class="sidebar-item"         href="/admin/index.html">Active submissions</a>
        <a id="nav-groups"  class="sidebar-item"         href="/admin/groups.html">Groups</a>
        <a id="nav-billing" class="sidebar-item active"  href="/admin/billing.html">Billing</a>
        <a id="nav-reports" class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a id="nav-settings" class="sidebar-item" href="#" title="Coming soon">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <!-- Top bar -->
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <strong>Billing</strong>
          </div>
          <div class="top-actions">
            <button id="btnBatchSend" class="btn primary" type="button" disabled>
              Create &amp; Send Invoices
            </button>
          </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <input id="q" type="search" placeholder="Search customer or submission…" />
          <div class="filters"></div>
          <span class="spacer"></span>
          <span id="countPill" class="pill">0</span>
        </div>

        <!-- Table -->
        <div class="table-wrap">
          <div class="table-scroller">
            <table class="table" id="subsTable">
              <thead id="subsHead"></thead>
              <tbody id="subsTbody"></tbody>
            </table>
          </div>
          <div id="subsEmpty" class="empty hide">No customers to bill.</div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <span class="page-range" id="page-range">0–0 of 0</span>
          <button class="page-btn" id="prev-page">‹</button>
          <button class="page-btn" id="next-page">›</button>
        </div>
      </main>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    document.addEventListener('DOMContentLoaded', () => {
      $('sidebar-signout')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await fetch('/api/admin-logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
        window.location.replace('/admin');
      });

      import('/admin/js/billing.app.js')
        .then(mod => mod.showBillingView?.())
        .catch(err => {
          console.error(err);
          $('subsTbody')?.insertAdjacentHTML(
            'beforeend',
            '<tr><td colspan="8" class="error">Failed to load billing module.</td></tr>'
          );
        });
    });
  </script>

  <!-- ===== Draft Builder Overlay (compact header, single scroller) ===== -->
  <div id="draftOverlay" class="hide" style="position:fixed;inset:0;z-index:1000;">
    <div id="draftBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.35);"></div>

    <div id="draftPanel" role="dialog" aria-modal="true"
         style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
                width:min(1200px,96vw);max-height:92vh;overflow:hidden;border-radius:16px;
                background:#fff;box-shadow:0 20px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;">
      <!-- header -->
      <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #eee;">
        <div style="flex:1 1 auto;">
          <div style="font-weight:700;">Draft Invoice Preview</div>
          <div class="muted" style="font-size:12px;">
            <span class="js-cust-email"></span> ·
            <span class="js-sub-count">0</span> submissions ·
            <span class="js-card-count">0</span> cards
          </div>
        </div>
        <button type="button" id="btnDraftSave" class="btn" style="min-width:120px;" disabled>Save</button>
        <button type="button" id="btnDraftBuild" class="btn primary" style="min-width:140px;">Open Builder</button>
        <button type="button" id="btnDraftClose" class="btn" style="min-width:72px;">Close</button>
      </div>

      <!-- body -->
      <!-- NOTE: no scrolling here; only the table below will scroll -->
      <div id="draftBody" style="padding:12px 16px;overflow:visible;">
        <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start;">
          <!-- left: compact info boxes -->
          <div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <!-- Submissions box -->
              <div style="border:1px solid #eee;border-radius:12px;padding:10px;">
                <div style="font-weight:600;margin-bottom:6px;">Submissions</div>
                <div class="js-sub-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
              </div>

              <!-- Groups box -->
              <div style="border:1px solid #eee;border-radius:12px;padding:10px;">
                <div style="font-weight:600;margin-bottom:6px;">Groups</div>
                <div class="js-group-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
              </div>
            </div>

            <!-- Received range (small, under the boxes) -->
            <div class="js-range muted" style="margin-top:8px;font-size:12px;"></div>
          </div>

          <!-- right: summary -->
          <div>
            <div style="border:1px solid #eee;border-radius:12px;padding:12px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                <div>Subtotal (est.)</div>
                <div class="js-subtotal">$—</div>
              </div>
              <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                <div>Shipping (flat)</div>
                <div class="js-ship">$5.00</div>
              </div>
              <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #eee;font-weight:700;">
                <div>Total (est.)</div>
                <div class="js-total">$—</div>
              </div>
              <div class="muted" style="font-size:12px;margin-top:8px;">Tax will be calculated by Shopify on save.</div>
            </div>
          </div> <!-- end right summary column -->
        </div>   <!-- end grid (left+right) -->

        <!-- Cards (table is the only scroll area) -->
        <div style="margin-top:12px;">
          <div style="font-weight:600;margin-bottom:6px;">Cards</div>
          <div class="cards-wrap" style="border:1px solid #eee;border-radius:12px;
                                         /* only the table scrolls, always visible */
                                         height:calc(92vh - 220px);
                                         overflow:auto;">
            <table class="cards-table" style="width:100%;min-width:960px;border-collapse:separate;border-spacing:0;table-layout:fixed;">
              <colgroup>
                <col style="width:140px;">  <!-- Submission -->
                <col style="width:120px;">  <!-- Date of break -->
                <col style="width:160px;">  <!-- Break channel -->
                <col style="width:110px;">  <!-- Break # -->
                <col style="width:auto;">   <!-- Card description -->
                <col style="width:120px;">  <!-- Grading ($) -->
                <col style="width:140px;">  <!-- Upcharge ($) -->
              </colgroup>
              <thead>
                <tr style="background:#f8fafc;">
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Submission</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Date of break</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Break channel</th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Break #</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Card description</th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Grading ($)</th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Upcharge ($)</th>
                </tr>
              </thead>
              <tbody id="cardsTbody"></tbody>
            </table>
          </div>
        </div>
      </div> <!-- end #draftBody -->

      <!-- Confirm Close Modal (direct child of #draftPanel) -->
      <div id="confirmCloseModal" class="hide"
           style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
                  background:rgba(0,0,0,0.35);">
        <div style="width:min(460px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.25);
                    padding:18px;">
          <div style="font-weight:700;font-size:16px;margin-bottom:6px;">Unsaved changes</div>
          <div class="muted" style="font-size:13px;margin-bottom:14px;">
            Do you want to save your changes before closing?
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button type="button" id="btnConfirmCancel" class="btn">Cancel</button>
            <button type="button" id="btnConfirmDiscard" class="btn" style="background:#f1f5f9;">Discard</button>
            <button type="button" id="btnConfirmSave" class="btn primary">Save &amp; Close</button>
          </div>
        </div>
      </div>

    </div> <!-- end #draftPanel -->
  </div>   <!-- end #draftOverlay -->

<script type="module">
(function () {
  const $ = (id) => document.getElementById(id);

  // --- Settings (dynamic with safe fallbacks) ---
  const DEFAULT_SETTINGS = { grade_fee: 20.00, shipping: 5.00 };
  let SETTINGS = { ...DEFAULT_SETTINGS };
  const SAVE_UPCHARGES_ENDPOINT = '/api/admin/billing/preview/save';

  async function loadSettings(){
    try {
      const r = await fetch('/api/admin/settings', { credentials: 'same-origin' });
      if (r.ok) {
        const j = await r.json().catch(() => ({}));
        const s = j?.settings || j || {};
        SETTINGS = {
          grade_fee: Number(s.grade_fee) || DEFAULT_SETTINGS.grade_fee,
          shipping : Number(s.shipping)  || DEFAULT_SETTINGS.shipping,
        };
      }
    } catch {}
  }

  function money(n){
    const x = Number(n);
    return Number.isFinite(x) ? x.toLocaleString(undefined, { style:'currency', currency:'USD' }) : '$—';
  }

  function esc(s) {
    return String(s == null ? "" : s).replace(/[&<>"']/g, function (c) {
      switch (c) { case "&": return "&amp;"; case "<": return "&lt;"; case ">": return "&gt;"; case '"': return "&quot;"; case "'": return "&#39;"; default: return c; }
    });
  }
  function pill(text) {
    const span = document.createElement("span");
    span.textContent = text;
    span.style.display = "inline-block";
    span.style.padding = "4px 8px";
    span.style.border = "1px solid #e5e7eb";
    span.style.borderRadius = "999px";
    span.style.fontSize = "12px";
    span.style.background = "#f8fafc";
    return span;
  }
  function setList(el, arr) {
    if (!el) return;
    el.innerHTML = "";
    (arr || []).forEach((v) => el.appendChild(pill(v)));
  }

  function fmtDateISOish(v){
    if (!v) return "—";
    const d = new Date(v);
    if (Number.isNaN(d.getTime())) {
      const s = String(v); return s.length >= 10 ? s.slice(0,10) : s;
    }
    return d.toISOString().slice(0,10);
  }

function normalizeCardRow(r) {
  return {
    id         : r.id || r.card_id || r.uuid || null, // <-- needs to come from your API
    submission : r.submission_id || r.submission_code || r.submission || "",
    date       : r.break_date || r.break_at || r.date_of_break || null,
    channel    : r.break_channel || r.channel || r.break || "",
    breakNo    : r.break_num || r.break_number || r.break_no || r.break_id || "",
    desc       : r.card_description || r.description || r.card || r.title || ""
  };
}


  async function fetchCardsForSubs(subIds){
    if (!subIds.length) return [];
    const qs = new URLSearchParams({ subs: subIds.join(",") }).toString();
    try {
      const r = await fetch(`/api/admin/billing/cards-preview?${qs}`, { credentials: "same-origin" });
      const j = await r.json().catch(() => ({ rows: [] }));
      const rows = Array.isArray(j.rows) ? j.rows : [];
      return rows.map(normalizeCardRow);
    } catch {
      return [];
    }
  }

  // --- Prefill helpers (reads saved values back into the inputs) ---
let draftInvoiceId = null; // reused across saves
let hasUnsavedChanges = false;


async function loadPrefillForSubs(submissionIds) {
  if (!submissionIds?.length) return { invoice_id: null, items: [] };
  const qs = encodeURIComponent(submissionIds.join(','));
  const r = await fetch(`/api/admin/billing/preview/prefill?subs=${qs}`, { credentials: 'same-origin' });
  if (!r.ok) return { invoice_id: null, items: [] };
  return r.json();
}

function applyPrefillToUI(prefill) {
  if (!prefill || !Array.isArray(prefill.items) || !prefill.items.length) return;
  const map = new Map(prefill.items.map(it => [String(it.card_id), it]));
  document.querySelectorAll('#cardsTbody input.js-up').forEach(inp => {
    const id = String(inp.getAttribute('data-id') || '');
    const it = map.get(id);
    if (!it) return;
    const dollars = (Number(it.upcharge_cents || 0) / 100).toFixed(2);
    inp.value = dollars;
  });
  draftInvoiceId = prefill.invoice_id || null;
  recalcFromDOM();
}

  function showConfirmClose(show) {
  const m = document.getElementById('confirmCloseModal');
  if (!m) return;
  m.classList.toggle('hide', !show);
}

async function handleAttemptClose() {
  if (!hasUnsavedChanges) { closeOverlay(); return; }
  showConfirmClose(true);
}

function wireConfirmModal() {
  const bSave = document.getElementById('btnConfirmSave');
  const bDiscard = document.getElementById('btnConfirmDiscard');
  const bCancel = document.getElementById('btnConfirmCancel');

  bCancel?.addEventListener('click', () => showConfirmClose(false));
  bDiscard?.addEventListener('click', () => {
    hasUnsavedChanges = false;
    showConfirmClose(false);
    closeOverlay();
  });
  bSave?.addEventListener('click', async () => {
    await saveUpchargesToDB(false);
    if (!hasUnsavedChanges) {
      showConfirmClose(false);
      closeOverlay();
    }
  });
}

  // --- Totals helpers ---
  function updateTotals(gradeSum, upchargeSum){
    const ship = SETTINGS.shipping;
    const subtotal = gradeSum + upchargeSum;
    const total = subtotal + ship;

    const elSub = document.querySelector(".js-subtotal");
    const elTot = document.querySelector(".js-total");
    const elShip = document.querySelector(".js-ship");

    if (elSub) elSub.textContent = money(subtotal);
    if (elTot) elTot.textContent = money(total);
    if (elShip) elShip.textContent = money(ship);
  }

  function recalcFromDOM(){
    const tb = document.getElementById("cardsTbody");
    if (!tb) return;
    const rows = Array.from(tb.querySelectorAll("tr[data-row]"));
    const gradeSum = rows.length * SETTINGS.grade_fee;
    const upchargeSum = rows.reduce((sum, tr) => {
      const v = Number(tr.querySelector(".js-up")?.value || 0);
      return sum + (Number.isFinite(v) ? v : 0);
    }, 0);
    updateTotals(gradeSum, upchargeSum);
  }

  function collectUpcharges() {
  const items = [];
  document.querySelectorAll('#cardsTbody input.js-up').forEach(inp => {
    const cardId = inp.getAttribute('data-id');
    const dollars = Number(inp.value || 0);
    if (!cardId) return;               // skip rows without id
    if (!Number.isFinite(dollars)) return;
    items.push({
      card_id: cardId,
      upcharge_cents: Math.round(dollars * 100)
    });
  });
  return items;
}

async function saveUpchargesToDB(silent = false) {
  const email = (lastBundle?.customer_email || '').trim();
  const items = collectUpcharges();

  // Quiet short-circuits while typing
  if (!email) { if (!silent) alert('Missing customer email.'); return; }
  if (!items.length) { if (!silent) alert('Nothing to save.'); return; }

  try {
    const btn = document.getElementById('btnDraftSave');
    if (btn) { btn.disabled = true; btn.textContent = 'Saving…'; }
    const res = await fetch(SAVE_UPCHARGES_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ customer_email: email, items, invoice_id: draftInvoiceId || null })
    });

if (!res.ok) {
  const t = await res.text().catch(()=> '');
  console.error('Save failed', t);
  if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
  if (!silent) alert('Failed to save upcharges.');
  return;
}

const j = await res.json().catch(()=> ({}));
if (j && j.invoice_id) draftInvoiceId = j.invoice_id;
hasUnsavedChanges = false;
if (btn) {
  btn.disabled = true;
  btn.textContent = 'Saved ✓';
  setTimeout(() => { btn.textContent = 'Save'; }, 1200);
}
// (no alert needed on explicit save; keep if you want)
  } catch (err) {
    const btn = document.getElementById('btnDraftSave');
    if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
    console.error(err);
    if (!silent) alert('Failed to save upcharges.');
  }
}

  function debounce(fn, ms) {
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}

  async function fillCardsTable(subIds, subsFallback){
    const tb = document.getElementById("cardsTbody");
    if (!tb) return;
    tb.innerHTML = "";

    let rows = await fetchCardsForSubs(subIds);

    if (!rows.length && Array.isArray(subsFallback)) {
      rows = subsFallback.flatMap(s => {
        const sid = s?.submission_id || s?.submission_code || "";
        const count = Number(s?.cards) || 0;
        return Array.from({ length: count }, (_, i) => ({
          submission: sid, date: null, channel: "", breakNo: (i + 1), desc: ""
        }));
      });
    }

    if (!rows.length) {
      tb.innerHTML = '<tr><td colspan="7" style="padding:12px;text-align:center;color:#6b7280;">No card rows to show.</td></tr>';
      updateTotals(0, 0);
      return;
    }

tb.innerHTML = rows.map((r, idx) => `
  <tr data-row="${idx}" data-id="${esc(r.id || '')}">
    <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.submission)}</td>
    <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;">${esc(fmtDateISOish(r.date))}</td>
    <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.channel || "—")}</td>
    <td style="padding:8px 12px;border-top:1px solid #f1f5f9;text-align:right;white-space:nowrap;">${esc(String(r.breakNo || "—"))}</td>
    <td style="padding:8px 12px;border-top:1px solid #f1f5f9;overflow:hidden;text-overflow:ellipsis;">${esc(r.desc || "—")}</td>
    <td style="padding:8px 12px;border-top:1px solid #f1f5f9;text-align:right;white-space:nowrap;" class="js-grade">${money(SETTINGS.grade_fee)}</td>
    <td style="padding:6px 12px;border-top:1px solid #f1f5f9;text-align:right;">
      <input class="js-up" data-id="${esc(r.id || '')}" type="number" step="0.01" min="0" value="0.00" style="width:100px;text-align:right;" />
    </td>
  </tr>
`).join("");

    // wire upcharge inputs to totals
function setSaveEnabled(on){
  const b = document.getElementById('btnDraftSave');
  if (b) b.disabled = !on;
}

tb.querySelectorAll(".js-up").forEach(inp => {
  inp.addEventListener("input", () => {
    recalcFromDOM();
    setSaveEnabled(true);
    hasUnsavedChanges = true;
  });
});



    recalcFromDOM();
  }

  function openOverlay() { const wrap = $("draftOverlay"); if (wrap) wrap.classList.remove("hide"); }
  function closeOverlay() { const wrap = $("draftOverlay"); if (wrap) wrap.classList.add("hide"); }

  let lastBundle = null;

  async function populate(bundle) {
    const subs = Array.isArray(bundle && bundle.submissions) ? bundle.submissions : [];
    const groups = Array.isArray(bundle && bundle.groups)
      ? bundle.groups
      : (Array.isArray(bundle && bundle.group_codes) ? bundle.group_codes : []);

    const emailEl = document.querySelector(".js-cust-email");
    if (emailEl) emailEl.textContent = (bundle && bundle.customer_email) || "";

    const subCt = document.querySelector(".js-sub-count");
    if (subCt) subCt.textContent = String(subs.length);

    const cardCt = document.querySelector(".js-card-count");
    if (cardCt) {
      const counted = subs.reduce((a, s) => a + (Number(s && s.cards) || 0), 0);
      cardCt.textContent = String((bundle && bundle.cards != null) ? bundle.cards : counted);
    }

    setList(document.querySelector(".js-sub-list"), subs.map(s => s && s.submission_id).filter(Boolean));
    setList(document.querySelector(".js-group-list"), Array.from(new Set((groups || []).filter(Boolean))));

    const oldest = (bundle && bundle.returned_oldest) ||
                   subs.map(s => s && s.returned_at).filter(Boolean).sort()[0] || null;
    const newest = (bundle && bundle.returned_newest) ||
                   subs.map(s => s && s.returned_at).filter(Boolean).sort().slice(-1)[0] || null;
    const rangeEl = document.querySelector(".js-range");
    if (rangeEl) rangeEl.textContent = (oldest || newest) ? ("Oldest: " + (oldest || "—") + " • Newest: " + (newest || "—")) : "—";

    const subIds = subs.map(s => s && s.submission_id).filter(Boolean);
    await fillCardsTable(subIds, subs);
    // Prefill any saved values for these submissions (if a draft exists)
try {
  const pre = await loadPrefillForSubs(subIds);
  applyPrefillToUI(pre);
} catch {}

    document.getElementById('btnDraftSave')?.setAttribute('disabled','');

    const subEl = document.querySelector(".js-subtotal"); if (subEl) subEl.textContent = "$—";
    const shipEl = document.querySelector(".js-ship");     if (shipEl) shipEl.textContent = money(SETTINGS.shipping);
    const totEl  = document.querySelector(".js-total");    if (totEl)  totEl.textContent  = "$—";
  }

  // open from table: ensure settings loaded first
  window.psaOpenDraftPreview = async function (bundle) {
    lastBundle = bundle || {};
    await loadSettings();
    await populate(lastBundle);
    openOverlay();
  };

  // Open Builder page with the same bundle
  function openBuilderFromPreview(){
    if (!lastBundle) return;
    try { sessionStorage.setItem('psa:builder:bundle', JSON.stringify(lastBundle)); } catch {}
    window.location.href = '/admin/invoice-builder.html';
  }

  $("btnDraftSave") && $("btnDraftSave").addEventListener("click", saveUpchargesToDB);
  $("btnDraftBuild") && $("btnDraftBuild").addEventListener("click", openBuilderFromPreview);
  $("btnDraftClose") && $("btnDraftClose").addEventListener("click", handleAttemptClose);
  $("draftBackdrop") && $("draftBackdrop").addEventListener("click", handleAttemptClose);
  window.addEventListener("keydown", (e) => { if (e.key === "Escape") handleAttemptClose(); });
  wireConfirmModal();

})();
</script>
</body>
</html>
