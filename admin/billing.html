<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSA Admin – Billing</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
</head>
<body>

  <!-- APP SHELL -->
  <div id="shell">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a id="nav-active"  class="sidebar-item"         href="/admin/index.html">Active submissions</a>
        <a id="nav-groups"  class="sidebar-item"         href="/admin/groups.html">Groups</a>
        <a id="nav-billing" class="sidebar-item active"  href="/admin/billing.html">Billing</a>
        <a id="nav-reports" class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a id="nav-settings" class="sidebar-item" href="#" title="Coming soon">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <!-- Top bar -->
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <strong>Billing</strong>
          </div>
          <div class="top-actions">
            <button id="btnBatchSend" class="btn primary" type="button" disabled>
              Create &amp; Send Invoices
            </button>
          </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <input id="q" type="search" placeholder="Search customer or submission…" />
          <div class="filters"><!-- reserved for future filters (group/date) --></div>
          <span class="spacer"></span>
          <span id="countPill" class="pill">0</span>
        </div>

        <!-- Table (match Active submissions layout exactly) -->
        <div class="table-wrap">
          <div class="table-scroller">
            <table class="table" id="subsTable">
              <thead id="subsHead"></thead>
              <tbody id="subsTbody"></tbody>
            </table>
          </div>
          <div id="subsEmpty" class="empty hide">No customers to bill.</div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <span class="page-range" id="page-range">0–0 of 0</span>
          <button class="page-btn" id="prev-page">‹</button>
          <button class="page-btn" id="next-page">›</button>
        </div>
      </main>
    </div>
  </div>

  <!-- Simple boot (no auth logic here; APIs enforce auth) -->
  <script>
    const $ = (id) => document.getElementById(id);

    document.addEventListener('DOMContentLoaded', () => {
      // Sign out (same behavior as other pages)
      $('sidebar-signout')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await fetch('/api/admin-logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
        window.location.replace('/admin');
      });

      // Load billing module
      import('/admin/js/billing.app.js')
        .then(mod => mod.showBillingView?.())
        .catch(err => {
          console.error(err);
          $('subsTbody')?.insertAdjacentHTML(
            'beforeend',
            '<tr><td colspan="8" class="error">Failed to load billing module.</td></tr>'
          );
        });
    });
  </script>

  <!-- ===== Draft Builder Overlay (read-only preview for now) ===== -->
  <div id="draftOverlay" class="hide" style="position:fixed;inset:0;z-index:1000;">
    <!-- backdrop -->
    <div id="draftBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.35);"></div>

    <!-- panel -->
    <div id="draftPanel" role="dialog" aria-modal="true"
         style="position:absolute;left:50%;top:48%;transform:translate(-50%,-50%);
                width:min(960px,92vw);max-height:82vh;overflow:hidden;border-radius:16px;
                background:#fff;box-shadow:0 20px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;">
      <!-- header -->
      <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #eee;">
        <div style="flex:1 1 auto;">
          <div style="font-weight:700;">Draft Invoice Preview</div>
          <div class="muted" style="font-size:12px;">
            <span class="js-cust-email"></span> ·
            <span class="js-sub-count">0</span> submissions ·
            <span class="js-card-count">0</span> cards
          </div>
        </div>
        <button type="button" id="btnDraftClose" class="btn" style="min-width:72px;">Close</button>
      </div>

      <!-- body -->
      <div id="draftBody" style="padding:12px 16px;overflow:auto;">
        <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;">
          <!-- left: lists -->
          <div>
            <div style="font-weight:600;margin-bottom:6px;">Submissions</div>
            <div class="muted" style="margin-bottom:10px;">(read-only preview)</div>
            <div class="js-sub-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>

            <div style="font-weight:600;margin:16px 0 6px;">Groups</div>
            <div class="js-group-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>

            <div style="font-weight:600;margin:16px 0 6px;">Received range</div>
            <div class="js-range muted"></div>
          </div>

          <!-- right: summary -->
          <div>
            <div style="border:1px solid #eee;border-radius:12px;padding:12px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                <div>Subtotal (est.)</div>
                <div class="js-subtotal">$—</div>
              </div>
              <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                <div>Shipping (flat)</div>
                <div class="js-ship">$5.00</div>
              </div>
              <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #eee;font-weight:700;">
                <div>Total (est.)</div>
                <div class="js-total">$—</div>
              </div>
              <div class="muted" style="font-size:12px;margin-top:8px;">Tax will be calculated by Shopify on save.</div>
            </div>
          </div>
        </div>

        <!-- Cards (read-only for this step) -->
        <div style="margin-top:16px;">
          <div style="font-weight:600;margin-bottom:6px;">Cards</div>
          <div class="muted" style="font-size:12px;margin-bottom:8px;">
            Grouped by submission. Per-card details will be editable in the next step.
          </div>
          <div class="cards-wrap" style="border:1px solid #eee;border-radius:12px;overflow:auto;max-height:44vh;">
            <table class="cards-table" style="width:100%;min-width:760px;border-collapse:separate;border-spacing:0;table-layout:fixed;">
              <colgroup>
                <col style="width:140px;">   <!-- Submission -->
                <col style="width:120px;">   <!-- Date of break -->
                <col style="width:160px;">   <!-- Break channel -->
                <col style="width:110px;">   <!-- Break # -->
                <col style="width:auto;">    <!-- Card description -->
              </colgroup>
              <thead>
                <tr style="background:#f8fafc;">
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Submission</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Date of break</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Break channel</th>
                  <th style="text-align:right;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Break #</th>
                  <th style="text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;">Card description</th>
                </tr>
              </thead>
              <tbody id="cardsTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
(function () {
  const $ = (id) => document.getElementById(id);

  // currency + html-escape helpers (no HTML comments anywhere in JS)
  function money(n) {
    const num = Number(n);
    return Number.isFinite(num)
      ? num.toLocaleString(undefined, { style: "currency", currency: "USD" })
      : "$—";
  }
  function esc(s) {
    return String(s == null ? "" : s).replace(/[&<>"']/g, function (c) {
      switch (c) {
        case "&": return "&amp;";
        case "<": return "&lt;";
        case ">": return "&gt;";
        case '"': return "&quot;";
        case "'": return "&#39;";
        default: return c;
      }
    });
  }
  function pill(text) {
    const span = document.createElement("span");
    span.textContent = text;
    span.style.display = "inline-block";
    span.style.padding = "4px 8px";
    span.style.border = "1px solid #e5e7eb";
    span.style.borderRadius = "999px";
    span.style.fontSize = "12px";
    span.style.background = "#f8fafc";
    return span;
  }
  function setList(el, arr) {
    if (!el) return;
    el.innerHTML = "";
    (arr || []).forEach((v) => el.appendChild(pill(v)));
  }

function fmtDateISOish(v){
  if (!v) return "—";
  const d = new Date(v);
  if (Number.isNaN(d.getTime())) {
    const s = String(v); return s.length >= 10 ? s.slice(0,10) : s;
  }
  return d.toISOString().slice(0,10);
}

function normalizeCardRow(r) {
  return {
    submission : r.submission_id || r.submission_code || r.submission || "",
    date       : r.break_date || r.break_at || r.date_of_break || null,
    channel    : r.break_channel || r.channel || r.break || "",
    breakNo    : r.break_num || r.break_number || r.break_no || r.break_id || "",
    desc       : r.card_description || r.description || r.card || r.title || ""
  };
}

async function fetchCardsForSubs(subIds){
  if (!subIds.length) return [];
  const qs = new URLSearchParams({ subs: subIds.join(",") }).toString();
  try {
    const r = await fetch(`/api/admin/billing/cards-preview?${qs}`, { credentials: "same-origin" });
    const j = await r.json().catch(() => ({ rows: [] }));
    const rows = Array.isArray(j.rows) ? j.rows : [];
    return rows.map(normalizeCardRow);
  } catch {
    return [];
  }
}

async function fillCardsTable(subIds, subsFallback){
  const tb = document.getElementById("cardsTbody");
  if (!tb) return;
  tb.innerHTML = "";

  let rows = await fetchCardsForSubs(subIds);

  // If we got nothing, fall back to 1..N per submission (same as before)
  if (!rows.length && Array.isArray(subsFallback)) {
    rows = subsFallback.flatMap(s => {
      const sid = s?.submission_id || s?.submission_code || "";
      const count = Number(s?.cards) || 0;
      return Array.from({ length: count }, (_, i) => ({
        submission: sid,
        date: null,
        channel: "",
        breakNo: (i + 1),
        desc: ""
      }));
    });
  }

  if (!rows.length) {
    tb.innerHTML = '<tr><td colspan="5" style="padding:12px;text-align:center;color:#6b7280;">No card rows to show.</td></tr>';
    return;
  }

  tb.innerHTML = rows.map(r => `
    <tr>
      <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.submission)}</td>
      <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;">${esc(fmtDateISOish(r.date))}</td>
      <td style="padding:8px 12px;border-top:1px solid #f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.channel || "—")}</td>
      <td style="padding:8px 12px;border-top:1px solid #f1f5f9;text-align:right;white-space:nowrap;">${esc(String(r.breakNo || "—"))}</td>
      <td style="padding:8px 12px;border-top:1px solid #f1f5f9;overflow:hidden;text-overflow:ellipsis;">${esc(r.desc || "—")}</td>
    </tr>
  `).join("");
}

  function openOverlay() { const wrap = $("draftOverlay"); if (wrap) wrap.classList.remove("hide"); }
  function closeOverlay() { const wrap = $("draftOverlay"); if (wrap) wrap.classList.add("hide"); }

  function populate(bundle) {
    const subs = Array.isArray(bundle && bundle.submissions) ? bundle.submissions : [];
    const groups = Array.isArray(bundle && bundle.groups)
      ? bundle.groups
      : (Array.isArray(bundle && bundle.group_codes) ? bundle.group_codes : []);

    const emailEl = document.querySelector(".js-cust-email");
    if (emailEl) emailEl.textContent = (bundle && bundle.customer_email) || "";

    const subCt = document.querySelector(".js-sub-count");
    if (subCt) subCt.textContent = String(subs.length);

    const cardCt = document.querySelector(".js-card-count");
    if (cardCt) {
      const counted = subs.reduce((a, s) => a + (Number(s && s.cards) || 0), 0);
      cardCt.textContent = String((bundle && bundle.cards != null) ? bundle.cards : counted);
    }

    setList(document.querySelector(".js-sub-list"), subs.map(s => s && s.submission_id).filter(Boolean));
    setList(document.querySelector(".js-group-list"), Array.from(new Set((groups || []).filter(Boolean))));

    const oldest = (bundle && bundle.returned_oldest) ||
                   subs.map(s => s && s.returned_at).filter(Boolean).sort()[0] || null;
    const newest = (bundle && bundle.returned_newest) ||
                   subs.map(s => s && s.returned_at).filter(Boolean).sort().slice(-1)[0] || null;
    const rangeEl = document.querySelector(".js-range");
    if (rangeEl) rangeEl.textContent = (oldest || newest) ? ("Oldest: " + (oldest || "—") + " • Newest: " + (newest || "—")) : "—";

    const subIds = subs.map(s => s && s.submission_id).filter(Boolean);
    fillCardsTable(subIds, subs);


    const subEl = document.querySelector(".js-subtotal"); if (subEl) subEl.textContent = "$—";
    const shipEl = document.querySelector(".js-ship");     if (shipEl) shipEl.textContent = "$5.00";
    const totEl = document.querySelector(".js-total");     if (totEl) totEl.textContent = "$—";
  }

  // public API
  window.psaOpenDraftPreview = function (bundle) { populate(bundle || {}); openOverlay(); };
  window.psaCloseDraftPreview = closeOverlay;

  // close handlers
  $("btnDraftClose") && $("btnDraftClose").addEventListener("click", closeOverlay);
  $("draftBackdrop") && $("draftBackdrop").addEventListener("click", closeOverlay);
  window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeOverlay(); });
})();
</script>
</body>
</html>
