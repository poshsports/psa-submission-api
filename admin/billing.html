<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSA Admin – Billing</title>
  <link rel="stylesheet" href="/admin/admin.css">
  <link rel="icon" href="data:,">
  <style>
    /* lightweight tab pills; safe + self-contained */
    .subtabs { display:flex; gap:8px; padding:10px 16px 0; }
    .subtabs a {
      display:inline-block; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px;
      text-decoration:none; color:#0f172a; font-size:14px; background:#fff;
    }
    .subtabs a.active { background:#eef2ff; border-color:#c7d2fe; font-weight:600; }
  </style>
</head>
<body>

  <!-- APP SHELL -->
  <div id="shell">
    <div class="admin-shell">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">PSA Admin</div>
        <a id="nav-active"  class="sidebar-item"         href="/admin/index.html">Active submissions</a>
        <a id="nav-groups"  class="sidebar-item"         href="/admin/groups.html">Groups</a>
        <a id="nav-billing" class="sidebar-item active"  href="/admin/billing.html">Billing</a>
        <a id="nav-reports" class="sidebar-item" href="#" title="Coming soon">Reports</a>
        <a id="nav-settings" class="sidebar-item" href="/admin/settings.html">Settings</a>
        <div class="sidebar-spacer"></div>
        <a id="sidebar-signout" class="sidebar-item" href="#">Sign out</a>
      </aside>

      <!-- Main -->
      <main class="admin-main">
        <!-- Top bar -->
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <strong>Billing</strong>
          </div>
          <div class="top-actions">
            <button id="btnBatchSend" class="btn primary" type="button" disabled title="Coming soon">
              Create &amp; Send Invoices
            </button>
          </div>
        </div>

        <!-- Subtabs (same page, different filters) -->
        <nav class="subtabs" role="tablist" aria-label="Billing views">
          <a href="/admin/billing.html?tab=to-send"   data-tab="to-send">To send</a>
          <a href="/admin/billing.html?tab=awaiting"  data-tab="awaiting">Awaiting payment</a>
          <a href="/admin/billing.html?tab=paid"      data-tab="paid">Paid</a>
        </nav>

        <!-- Toolbar -->
        <div class="toolbar">
          <input id="q" type="search" placeholder="Search customer or submission…" />
          <div class="filters"></div>
          <span class="spacer"></span>
          <span id="countPill" class="pill">0</span>
        </div>

        <!-- Table -->
        <div class="table-wrap">
          <div class="table-scroller">
            <table class="table" id="subsTable">
              <thead id="subsHead"></thead>
              <tbody id="subsTbody"></tbody>
            </table>
          </div>
          <div id="subsEmpty" class="empty hide">No customers to bill.</div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <span class="page-range" id="page-range">0–0 of 0</span>
          <button class="page-btn" id="prev-page">‹</button>
          <button class="page-btn" id="next-page">›</button>
        </div>
      </main>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    document.addEventListener('DOMContentLoaded', () => {
      // sign out
      $('sidebar-signout')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await fetch('/api/admin-logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
        window.location.replace('/admin');
      });

      // resolve selected tab (default: to-send)
      const params = new URLSearchParams(location.search);
      const currentTab = params.get('tab') || 'to-send';

      // highlight active tab
      document.querySelectorAll('.subtabs a[data-tab]').forEach(a => {
        a.classList.toggle('active', a.dataset.tab === currentTab);
      });

      // load app; passing currentTab is backward-compatible (extra args are ignored)
      import('/admin/js/billing.app.js')
        .then(mod => mod.showBillingView?.(currentTab))
        .catch(err => {
          console.error(err);
          $('subsTbody')?.insertAdjacentHTML(
            'beforeend',
            '<tr><td colspan="8" class="error">Failed to load billing module.</td></tr>'
          );
        });
    });
  </script>
</body>
</html>
